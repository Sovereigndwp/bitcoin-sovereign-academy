<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Integration Test Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #f7931a;
            margin-bottom: 10px;
        }

        .test-section {
            background: #2d2d2d;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #333;
        }

        .test-section h2 {
            color: #f7931a;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .test-item {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #666;
        }

        .test-item.pass {
            border-left-color: #4caf50;
        }

        .test-item.fail {
            border-left-color: #f44336;
        }

        .test-item.pending {
            border-left-color: #ff9800;
        }

        .test-name {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .test-status {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pass {
            background: #4caf50;
            color: white;
        }

        .status-fail {
            background: #f44336;
            color: white;
        }

        .status-pending {
            background: #ff9800;
            color: white;
        }

        .test-result {
            font-size: 14px;
            color: #ccc;
            margin-top: 8px;
            padding: 10px;
            background: #0d0d0d;
            border-radius: 4px;
            font-family: monospace;
        }

        button {
            padding: 12px 24px;
            background: #f7931a;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: #e8890d;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .api-key-input {
            width: 100%;
            padding: 12px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            color: #e0e0e0;
            margin-bottom: 15px;
        }

        .summary {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #f7931a;
            margin-bottom: 30px;
        }

        .summary h3 {
            color: #f7931a;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .stat {
            flex: 1;
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Gemini Integration Test Suite</h1>
        <p style="color: #999; margin-bottom: 30px;">Automated testing for Bitcoin Sovereign Academy AI features</p>

        <div class="summary" id="summary">
            <h3>Test Summary</h3>
            <p>Click "Run All Tests" to start testing</p>
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" style="color: #4caf50;" id="pass-count">0</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: #f44336;" id="fail-count">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" style="color: #ff9800;" id="pending-count">8</div>
                    <div class="stat-label">Pending</div>
                </div>
            </div>
        </div>

        <div style="margin-bottom: 30px;">
            <input type="text" class="api-key-input" id="api-key" placeholder="Enter Gemini API Key (optional - for live API tests)">
            <button onclick="runAllTests()">Run All Tests</button>
            <button onclick="runUnitTests()">Run Unit Tests Only</button>
            <button onclick="runIntegrationTests()" id="integration-btn" disabled>Run Integration Tests</button>
        </div>

        <!-- Unit Tests -->
        <div class="test-section">
            <h2>Unit Tests (No API Key Required)</h2>
            <div id="unit-tests"></div>
        </div>

        <!-- Integration Tests -->
        <div class="test-section">
            <h2>Integration Tests (Requires API Key)</h2>
            <div id="integration-tests"></div>
        </div>
    </div>

    <script src="js/gemini-service.js"></script>
    <script src="js/gemini-tutor-ui.js"></script>
    <script>
        let testResults = {
            pass: 0,
            fail: 0,
            pending: 8
        };

        const tests = {
            unit: [
                {
                    name: 'GeminiService class loads',
                    fn: () => typeof window.GeminiService !== 'undefined'
                },
                {
                    name: 'GeminiService initializes without API key',
                    fn: () => {
                        const service = new GeminiService();
                        return service !== null;
                    }
                },
                {
                    name: 'GeminiTutorUI class loads',
                    fn: () => typeof window.GeminiTutorUI !== 'undefined'
                },
                {
                    name: 'Global geminiService instance exists',
                    fn: () => window.geminiService !== undefined
                },
                {
                    name: 'Tutor button created in DOM',
                    fn: () => document.getElementById('gemini-tutor-btn') !== null
                },
                {
                    name: 'Chat interface created in DOM',
                    fn: () => document.getElementById('gemini-tutor-chat') !== null
                }
            ],
            integration: [
                {
                    name: 'API key can be set',
                    fn: async () => {
                        const key = document.getElementById('api-key').value;
                        if (!key) return false;
                        window.geminiService.setApiKey(key);
                        return window.geminiService.apiKey === key;
                    }
                },
                {
                    name: 'Gemini API connectivity test',
                    fn: async () => {
                        try {
                            const response = await window.geminiService.generateTutorResponse(
                                'Say "test successful" if you can read this',
                                { level: 'beginner', topic: 'test' }
                            );
                            return response && !response.includes('Error') && !response.includes('API key');
                        } catch (error) {
                            throw new Error(`API call failed: ${error.message}`);
                        }
                    }
                }
            ]
        };

        function updateStats() {
            document.getElementById('pass-count').textContent = testResults.pass;
            document.getElementById('fail-count').textContent = testResults.fail;
            document.getElementById('pending-count').textContent = testResults.pending;
        }

        function createTestElement(name, status, result) {
            const testItem = document.createElement('div');
            testItem.className = `test-item ${status}`;

            const statusClass = `status-${status}`;
            const statusText = status.toUpperCase();

            testItem.innerHTML = `
                <div class="test-name">
                    <span>${name}</span>
                    <span class="test-status ${statusClass}">${statusText}</span>
                </div>
                ${result ? `<div class="test-result">${result}</div>` : ''}
            `;

            return testItem;
        }

        async function runTest(test, container) {
            const pendingEl = createTestElement(test.name, 'pending', 'Running...');
            container.appendChild(pendingEl);

            try {
                const result = await test.fn();
                container.removeChild(pendingEl);

                if (result === true || result) {
                    const passEl = createTestElement(test.name, 'pass', '✓ Test passed');
                    container.appendChild(passEl);
                    testResults.pass++;
                    testResults.pending--;
                } else {
                    const failEl = createTestElement(test.name, 'fail', '✗ Test failed: returned false');
                    container.appendChild(failEl);
                    testResults.fail++;
                    testResults.pending--;
                }
            } catch (error) {
                container.removeChild(pendingEl);
                const failEl = createTestElement(test.name, 'fail', `✗ Error: ${error.message}`);
                container.appendChild(failEl);
                testResults.fail++;
                testResults.pending--;
            }

            updateStats();
        }

        async function runUnitTests() {
            const container = document.getElementById('unit-tests');
            container.innerHTML = '';

            testResults = { pass: 0, fail: 0, pending: tests.unit.length };
            updateStats();

            for (const test of tests.unit) {
                await runTest(test, container);
            }
        }

        async function runIntegrationTests() {
            const apiKey = document.getElementById('api-key').value;
            if (!apiKey) {
                alert('Please enter a Gemini API key first');
                return;
            }

            const container = document.getElementById('integration-tests');
            container.innerHTML = '';

            testResults.pending = tests.integration.length;
            updateStats();

            for (const test of tests.integration) {
                await runTest(test, container);
            }
        }

        async function runAllTests() {
            testResults = { pass: 0, fail: 0, pending: tests.unit.length + tests.integration.length };
            updateStats();

            await runUnitTests();

            const apiKey = document.getElementById('api-key').value;
            if (apiKey) {
                await runIntegrationTests();
            } else {
                const container = document.getElementById('integration-tests');
                container.innerHTML = '<p style="color: #ff9800;">⚠️ Skipping integration tests - no API key provided</p>';
                testResults.pending -= tests.integration.length;
                updateStats();
            }
        }

        // Enable integration tests button when API key is entered
        document.getElementById('api-key').addEventListener('input', (e) => {
            document.getElementById('integration-btn').disabled = !e.target.value;
        });

        // Auto-populate from localStorage if available
        window.addEventListener('load', () => {
            const savedKey = localStorage.getItem('gemini-api-key');
            if (savedKey) {
                document.getElementById('api-key').value = savedKey;
                document.getElementById('integration-btn').disabled = false;
            }
        });
    </script>
</body>
</html>
