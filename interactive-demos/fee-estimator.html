<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Real-time Bitcoin transaction fee estimator with sat/vB calculations">
    <title>Fee Estimator | Bitcoin Sovereign Academy</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="../css/brand.css">
    <link rel="stylesheet" href="../css/widgets.css">
    
    <style>
        body {
            background: #0f0f0f;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, #1a1a1a 0%, #242424 100%);
            border-radius: 16px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #F7931A 0%, #FFA940 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .current-fees {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .fee-tiers {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .fee-tier {
            background: #242424;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .fee-tier:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(247, 147, 26, 0.2);
        }
        
        .fee-tier.selected {
            border: 2px solid #F7931A;
        }
        
        .fee-tier.fast { border-top: 3px solid #00c853; }
        .fee-tier.medium { border-top: 3px solid #F7931A; }
        .fee-tier.economy { border-top: 3px solid #2196f3; }
        
        .tier-label {
            font-size: 0.875rem;
            color: #b0b0b0;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .tier-rate {
            font-size: 2rem;
            font-weight: 700;
            color: #F7931A;
            margin: 0.5rem 0;
        }
        
        .tier-time {
            color: #d0d0d0;
            font-size: 0.875rem;
        }
        
        .calculator-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #F7931A;
            font-weight: 600;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            background: #242424;
            border: 2px solid #333;
            border-radius: 8px;
            color: #ffffff;
            font-size: 1rem;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #F7931A;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        
        .help-text {
            font-size: 0.875rem;
            color: #b0b0b0;
            margin-top: 0.5rem;
        }
        
        .results-panel {
            background: #242424;
            padding: 2rem;
            border-radius: 12px;
            margin-top: 2rem;
        }
        
        .result-row {
            display: flex;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid #333;
        }
        
        .result-row:last-child {
            border-bottom: none;
        }
        
        .result-label {
            color: #b0b0b0;
        }
        
        .result-value {
            color: #F7931A;
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .total-row {
            background: #1a1a1a;
            margin: 1rem -2rem -2rem;
            padding: 1.5rem 2rem;
            border-radius: 0 0 12px 12px;
        }
        
        .total-row .result-value {
            font-size: 1.5rem;
        }
        
        .info-box {
            background: #242424;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
            border-left: 3px solid #2196f3;
        }
        
        .mempool-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .status-indicator.normal { background: #00c853; }
        .status-indicator.busy { background: #F7931A; }
        .status-indicator.congested { background: #ff1744; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .comparison-card {
            background: #0f0f0f;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #333;
        }
        
        @media (max-width: 768px) {
            .input-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>‚ö° Fee Estimator</h1>
            <p style="color: #b0b0b0;">
                Calculate Bitcoin transaction fees with real-time mempool data
            </p>
        </div>
        
        <!-- Current Network Fees -->
        <div class="current-fees">
            <h2 style="color: #F7931A; margin-bottom: 0.5rem;">Current Network Fees</h2>
            <div class="mempool-status">
                <span class="status-indicator" id="mempool-indicator"></span>
                <span id="mempool-status">Loading...</span>
            </div>
            
            <div class="fee-tiers">
                <div class="fee-tier fast" onclick="selectTier('fast')">
                    <div class="tier-label">‚ö° Fast</div>
                    <div class="tier-rate" id="fast-rate">--</div>
                    <div class="tier-time">~10 minutes</div>
                </div>
                
                <div class="fee-tier medium" onclick="selectTier('medium')">
                    <div class="tier-label">üöÄ Medium</div>
                    <div class="tier-rate" id="medium-rate">--</div>
                    <div class="tier-time">~30 minutes</div>
                </div>
                
                <div class="fee-tier economy" onclick="selectTier('economy')">
                    <div class="tier-label">üê¢ Economy</div>
                    <div class="tier-rate" id="economy-rate">--</div>
                    <div class="tier-time">~1 hour+</div>
                </div>
            </div>
        </div>
        
        <!-- Info Box -->
        <div class="info-box">
            <strong>üí° Understanding Transaction Fees</strong>
            <p style="margin-top: 0.5rem; color: #d0d0d0;">
                Bitcoin fees are measured in satoshis per virtual byte (sat/vB). Higher fees get priority in blocks. 
                The total fee depends on your transaction size, which is determined by the number of inputs and outputs.
            </p>
        </div>
        
        <!-- Calculator -->
        <div class="calculator-section">
            <h2 style="color: #F7931A; margin-bottom: 1.5rem;">Transaction Calculator</h2>
            
            <div class="input-grid">
                <div class="form-group">
                    <label for="num-inputs">Number of Inputs</label>
                    <input type="number" id="num-inputs" value="2" min="1" max="100" oninput="calculateFees()">
                    <div class="help-text">UTXOs you're spending (each ~148 vBytes)</div>
                </div>
                
                <div class="form-group">
                    <label for="num-outputs">Number of Outputs</label>
                    <input type="number" id="num-outputs" value="2" min="1" max="20" oninput="calculateFees()">
                    <div class="help-text">Addresses receiving funds (each ~34 vBytes)</div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="address-type">Address Type</label>
                <select id="address-type" onchange="calculateFees()">
                    <option value="segwit">SegWit (Native/Bech32) - Recommended</option>
                    <option value="wrapped">Wrapped SegWit (P2SH)</option>
                    <option value="legacy">Legacy (P2PKH)</option>
                </select>
                <div class="help-text">SegWit addresses start with bc1 and have lower fees</div>
            </div>
            
            <div class="form-group">
                <label for="fee-rate">Fee Rate (sat/vB)</label>
                <input type="number" id="fee-rate" value="10" min="1" max="1000" oninput="calculateFees()">
                <div class="help-text">Current recommended rates shown above</div>
            </div>
            
            <!-- Results -->
            <div class="results-panel">
                <h3 style="color: #F7931A; margin-bottom: 1rem;">Estimated Costs</h3>
                
                <div class="result-row">
                    <span class="result-label">Transaction Size</span>
                    <span class="result-value" id="tx-size">-- vBytes</span>
                </div>
                
                <div class="result-row">
                    <span class="result-label">Fee (sats)</span>
                    <span class="result-value" id="fee-sats">--</span>
                </div>
                
                <div class="result-row">
                    <span class="result-label">Fee (BTC)</span>
                    <span class="result-value" id="fee-btc">--</span>
                </div>
                
                <div class="result-row total-row">
                    <span class="result-label" style="font-size: 1.125rem; color: #ffffff;">Fee (USD)</span>
                    <span class="result-value" id="fee-usd">--</span>
                </div>
            </div>
            
            <!-- Comparison -->
            <div style="margin-top: 2rem;">
                <h3 style="color: #F7931A; margin-bottom: 1rem;">Fee Comparison by Priority</h3>
                <div class="comparison-grid" id="comparison-grid">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
        
        <!-- Tips -->
        <div class="info-box" style="border-left-color: #00c853;">
            <strong>‚úì Pro Tips</strong>
            <ul style="margin-top: 0.5rem; color: #d0d0d0; padding-left: 1.5rem;">
                <li style="margin: 0.5rem 0;">Use SegWit addresses (bc1) to save ~40% on fees</li>
                <li style="margin: 0.5rem 0;">Consolidate small UTXOs during low-fee periods</li>
                <li style="margin: 0.5rem 0;">Batch multiple payments into one transaction to save fees</li>
                <li style="margin: 0.5rem 0;">Use RBF (Replace-By-Fee) to bump fees if transaction stalls</li>
                <li style="margin: 0.5rem 0;">Check mempool congestion before making non-urgent transactions</li>
            </ul>
        </div>
        
        <!-- Back Link -->
        <div style="text-align: center; margin: 3rem 0;">
            <a href="../index.html" style="color: #F7931A; text-decoration: none;">‚Üê Back to Home</a>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="../js/widgets/api-handler.js"></script>
    
    <script>
        // Initialize
        const apiHandler = new BitcoinAPIHandler({ enableLogging: false });
        let currentBTCPrice = 97000;
        let currentFees = { fastest: 10, halfHour: 7, hour: 5, economy: 3 };
        let mempoolSize = 0;
        
        // Fetch current fees
        async function fetchCurrentFees() {
            try {
                const [fees, mempool, price] = await Promise.all([
                    apiHandler.getFeeRecommendations(),
                    apiHandler.getMempoolStats(),
                    apiHandler.getBitcoinPrice()
                ]);
                
                currentFees = {
                    fastest: fees.fastest || fees.fastestFee || 10,
                    halfHour: fees.halfHour || fees.hour || fees.hourFee || 7,
                    hour: fees.hour || fees.hourFee || 5,
                    economy: fees.economy || fees.economyFee || fees.minimum || 3
                };
                
                currentBTCPrice = price.price;
                mempoolSize = mempool.count;
                
                // Update display
                document.getElementById('fast-rate').textContent = `${currentFees.fastest} sat/vB`;
                document.getElementById('medium-rate').textContent = `${currentFees.halfHour} sat/vB`;
                document.getElementById('economy-rate').textContent = `${currentFees.economy} sat/vB`;
                
                // Update mempool status
                updateMempoolStatus(mempoolSize);
                
                // Set default fee rate
                document.getElementById('fee-rate').value = currentFees.halfHour;
                
                // Calculate initial fees
                calculateFees();
            } catch (error) {
                console.error('Error fetching fees:', error);
            }
        }
        
        function updateMempoolStatus(size) {
            const indicator = document.getElementById('mempool-indicator');
            const status = document.getElementById('mempool-status');
            
            if (size < 20000) {
                indicator.className = 'status-indicator normal';
                status.textContent = `Mempool: ${size.toLocaleString()} txs (Normal) ‚úì`;
            } else if (size < 50000) {
                indicator.className = 'status-indicator busy';
                status.textContent = `Mempool: ${size.toLocaleString()} txs (Busy) ‚ö†Ô∏è`;
            } else {
                indicator.className = 'status-indicator congested';
                status.textContent = `Mempool: ${size.toLocaleString()} txs (Congested) üî¥`;
            }
        }
        
        function selectTier(tier) {
            const feeRate = tier === 'fast' ? currentFees.fastest :
                           tier === 'medium' ? currentFees.halfHour :
                           currentFees.economy;
            
            document.getElementById('fee-rate').value = feeRate;
            
            // Visual feedback
            document.querySelectorAll('.fee-tier').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.fee-tier.${tier}`).classList.add('selected');
            
            calculateFees();
        }
        
        function calculateTransactionSize(inputs, outputs, addressType) {
            // Approximate sizes in vBytes
            const overhead = 10; // Version, locktime, etc.
            
            let inputSize, outputSize;
            
            switch (addressType) {
                case 'segwit':
                    inputSize = 68; // Native SegWit (Bech32)
                    outputSize = 31;
                    break;
                case 'wrapped':
                    inputSize = 91; // Wrapped SegWit
                    outputSize = 32;
                    break;
                case 'legacy':
                default:
                    inputSize = 148; // Legacy P2PKH
                    outputSize = 34;
                    break;
            }
            
            return overhead + (inputs * inputSize) + (outputs * outputSize);
        }
        
        function calculateFees() {
            const inputs = parseInt(document.getElementById('num-inputs').value) || 1;
            const outputs = parseInt(document.getElementById('num-outputs').value) || 1;
            const addressType = document.getElementById('address-type').value;
            const feeRate = parseFloat(document.getElementById('fee-rate').value) || 1;
            
            // Calculate size
            const size = calculateTransactionSize(inputs, outputs, addressType);
            
            // Calculate fees
            const feeSats = Math.ceil(size * feeRate);
            const feeBTC = feeSats / 100000000;
            const feeUSD = feeBTC * currentBTCPrice;
            
            // Update results
            document.getElementById('tx-size').textContent = `${size} vBytes`;
            document.getElementById('fee-sats').textContent = `${feeSats.toLocaleString()} sats`;
            document.getElementById('fee-btc').textContent = `${feeBTC.toFixed(8)} BTC`;
            document.getElementById('fee-usd').textContent = `$${feeUSD.toFixed(2)}`;
            
            // Update comparison
            updateComparison(size);
        }
        
        function updateComparison(size) {
            const comparisonGrid = document.getElementById('comparison-grid');
            const tiers = [
                { name: 'Fast', rate: currentFees.fastest, time: '~10 min' },
                { name: 'Medium', rate: currentFees.halfHour, time: '~30 min' },
                { name: 'Economy', rate: currentFees.economy, time: '~1 hour+' }
            ];
            
            comparisonGrid.innerHTML = tiers.map(tier => {
                const feeSats = Math.ceil(size * tier.rate);
                const feeUSD = (feeSats / 100000000) * currentBTCPrice;
                
                return `
                    <div class="comparison-card">
                        <div style="font-weight: 600; color: #F7931A; margin-bottom: 0.5rem;">${tier.name}</div>
                        <div style="color: #d0d0d0;">${tier.rate} sat/vB</div>
                        <div style="font-size: 1.25rem; margin: 0.5rem 0;">$${feeUSD.toFixed(2)}</div>
                        <div style="color: #b0b0b0; font-size: 0.875rem;">${tier.time}</div>
                    </div>
                `;
            }).join('');
        }
        
        // Initialize on load
        fetchCurrentFees();
        
        // Refresh fees every 30 seconds
        setInterval(fetchCurrentFees, 30000);
    </script>
</body>
</html>
