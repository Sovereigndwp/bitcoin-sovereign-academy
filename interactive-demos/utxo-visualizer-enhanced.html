<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced UTXO Visualizer - Bitcoin Sovereign Academy</title>
    <link rel="stylesheet" href="/css/brand.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: var(--color-brand);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--color-muted);
            font-size: 1.1rem;
        }

        .back-btn {
            position: absolute;
            top: 2rem;
            left: 2rem;
            background: var(--color-brand);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(247, 147, 26, 0.4);
        }

        /* Scenario Selector */
        .scenario-selector {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.1), rgba(103, 58, 183, 0.1));
            border: 2px solid rgba(156, 39, 176, 0.3);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .scenario-selector h3 {
            color: #9C27B0;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: 1.5rem;
        }

        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .scenario-card {
            background: rgba(156, 39, 176, 0.05);
            border: 2px solid rgba(156, 39, 176, 0.2);
            border-radius: 8px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .scenario-card:hover {
            border-color: #9C27B0;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.3);
        }

        .scenario-card.active {
            background: rgba(156, 39, 176, 0.15);
            border-color: #9C27B0;
        }

        .scenario-card .icon {
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 0.75rem;
        }

        .scenario-card h4 {
            color: #9C27B0;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .scenario-card p {
            font-size: 0.9rem;
            color: var(--color-muted);
            text-align: center;
        }

        .scenario-card .difficulty {
            display: inline-block;
            margin-top: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .difficulty.easy { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
        .difficulty.medium { background: rgba(255, 152, 0, 0.2); color: #FF9800; }
        .difficulty.hard { background: rgba(244, 67, 54, 0.2); color: #F44336; }

        /* Guided Instructions Panel */
        .instructions-panel {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(3, 169, 244, 0.05));
            border-left: 4px solid #2196F3;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: none;
        }

        .instructions-panel.visible {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .instructions-panel h3 {
            color: #2196F3;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .instruction-step {
            background: rgba(33, 150, 243, 0.05);
            border-left: 3px solid #2196F3;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
        }

        .instruction-step.completed {
            opacity: 0.5;
            border-left-color: #4CAF50;
        }

        .instruction-step.active {
            background: rgba(33, 150, 243, 0.15);
            border-left-width: 5px;
        }

        .step-number {
            display: inline-block;
            background: #2196F3;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        /* Main Layout */
        .utxo-workspace {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Wallet Section */
        .wallet-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--color-border);
        }

        .section-header h2 {
            color: var(--color-brand);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .balance-display {
            background: rgba(247, 147, 26, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            color: var(--color-brand);
        }

        /* UTXO Grid */
        .utxo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            min-height: 400px;
        }

        .utxo-coin {
            background: linear-gradient(135deg, #f7931a, #ff6b00);
            border: 3px solid #ff9800;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            user-select: none;
        }

        .utxo-coin:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 16px rgba(247, 147, 26, 0.4);
        }

        .utxo-coin.selected {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #4CAF50, #8BC34A);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 6px rgba(76, 175, 80, 0.4); }
            50% { box-shadow: 0 8px 20px rgba(76, 175, 80, 0.6); }
        }

        .utxo-coin.highlighted {
            animation: glow 1s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 10px rgba(247, 147, 26, 0.5); }
            50% { box-shadow: 0 0 25px rgba(247, 147, 26, 0.9); }
        }

        .coin-icon {
            font-size: 2rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .coin-amount {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .coin-label {
            text-align: center;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 0.25rem;
        }

        .coin-age {
            text-align: center;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.5rem;
        }

        .coin-privacy {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1rem;
        }

        /* Transaction Builder */
        .transaction-builder {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .drop-zone {
            border: 3px dashed var(--color-border);
            border-radius: 12px;
            padding: 2rem;
            min-height: 300px;
            background: rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .drop-zone-empty {
            text-align: center;
            color: var(--color-muted);
            padding: 3rem 1rem;
        }

        .drop-zone-empty .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .selected-utxos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }

        /* Transaction Summary */
        .tx-summary {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .tx-summary h3 {
            color: var(--color-brand);
            margin-bottom: 1rem;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--color-border);
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .summary-label {
            color: var(--color-muted);
        }

        .summary-value {
            color: var(--color-text);
            font-weight: 600;
        }

        .summary-value.highlight {
            color: var(--color-brand);
        }

        .summary-value.success {
            color: #4CAF50;
        }

        .summary-value.danger {
            color: #F44336;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--color-muted);
            font-weight: 600;
        }

        .control-group input,
        .control-group select {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            color: var(--color-text);
            font-size: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--color-brand);
            color: white;
        }

        .btn-primary:hover {
            background: #c77808;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(247, 147, 26, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-danger {
            background: #F44336;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        /* Insights Panel */
        .insights-panel {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(255, 193, 7, 0.05));
            border-left: 4px solid #FF9800;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .insights-panel h3 {
            color: #FF9800;
            margin-bottom: 1rem;
        }

        .insight-item {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background: rgba(255, 152, 0, 0.05);
            border-radius: 6px;
            border-left: 3px solid #FF9800;
        }

        .insight-item.warning {
            border-left-color: #F44336;
            background: rgba(244, 67, 54, 0.05);
        }

        .insight-item.success {
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.05);
        }

        .insight-item strong {
            color: #FF9800;
        }

        /* Privacy Analysis */
        .privacy-panel {
            background: linear-gradient(135deg, rgba(156, 39, 176, 0.1), rgba(103, 58, 183, 0.05));
            border-left: 4px solid #9C27B0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .privacy-panel h3 {
            color: #9C27B0;
            margin-bottom: 1rem;
        }

        .privacy-score {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .privacy-bar {
            flex: 1;
            height: 30px;
            background: rgba(156, 39, 176, 0.1);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .privacy-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #F44336, #FF9800, #4CAF50);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        /* Challenge Mode */
        .challenge-panel {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(3, 169, 244, 0.05));
            border: 2px solid #2196F3;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .challenge-panel h3 {
            color: #2196F3;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .challenge-objective {
            background: rgba(33, 150, 243, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .challenge-score {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(33, 150, 243, 0.3);
        }

        .score-item {
            text-align: center;
        }

        .score-item .label {
            font-size: 0.85rem;
            color: var(--color-muted);
            margin-bottom: 0.25rem;
        }

        .score-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2196F3;
        }

        /* Educational Tips */
        .tip-box {
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #4CAF50;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .tip-box h4 {
            color: #4CAF50;
            margin-bottom: 0.5rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .utxo-workspace {
                grid-template-columns: 1fr;
            }
            .scenario-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .scenario-grid {
                grid-template-columns: 1fr;
            }
            .utxo-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            .controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">← Back to Demos</a>

    <div class="container">
        <div class="header">
            <h1>🪙 Enhanced UTXO Visualizer</h1>
            <p>Master Bitcoin UTXO management through interactive scenarios and real-world simulations</p>
        </div>

        <!-- Scenario Selector -->
        <div class="scenario-selector">
            <h3>🎯 Choose a Learning Scenario</h3>
            <div class="scenario-grid">
                <div class="scenario-card active" data-scenario="intro">
                    <div class="icon">🎓</div>
                    <h4>Introduction to UTXOs</h4>
                    <p>Learn the basics of how Bitcoin tracks ownership</p>
                    <div style="text-align: center;">
                        <span class="difficulty easy">Easy</span>
                    </div>
                </div>

                <div class="scenario-card" data-scenario="consolidation">
                    <div class="icon">🔗</div>
                    <h4>UTXO Consolidation</h4>
                    <p>Merge small UTXOs when fees are low to save on future transactions</p>
                    <div style="text-align: center;">
                        <span class="difficulty medium">Medium</span>
                    </div>
                </div>

                <div class="scenario-card" data-scenario="fee-optimization">
                    <div class="icon">⚡</div>
                    <h4>Fee Optimization</h4>
                    <p>Select UTXOs efficiently to minimize transaction costs</p>
                    <div style="text-align: center;">
                        <span class="difficulty medium">Medium</span>
                    </div>
                </div>

                <div class="scenario-card" data-scenario="privacy">
                    <div class="icon">🔒</div>
                    <h4>Privacy Protection</h4>
                    <p>Avoid address reuse and maintain transaction privacy</p>
                    <div style="text-align: center;">
                        <span class="difficulty hard">Hard</span>
                    </div>
                </div>

                <div class="scenario-card" data-scenario="dust">
                    <div class="icon">🧹</div>
                    <h4>Dust Management</h4>
                    <p>Handle very small UTXOs that cost more to spend than they're worth</p>
                    <div style="text-align: center;">
                        <span class="difficulty medium">Medium</span>
                    </div>
                </div>

                <div class="scenario-card" data-scenario="challenge">
                    <div class="icon">🏆</div>
                    <h4>Expert Challenge</h4>
                    <p>Optimize for fees, privacy, and efficiency simultaneously</p>
                    <div style="text-align: center;">
                        <span class="difficulty hard">Hard</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Guided Instructions -->
        <div class="instructions-panel" id="instructions-panel">
            <h3><span>📋</span> Guided Instructions</h3>
            <div id="instructions-content"></div>
        </div>

        <!-- Main Workspace -->
        <div class="utxo-workspace">
            <!-- Wallet Section -->
            <div class="wallet-section">
                <div class="section-header">
                    <h2>👛 Your Wallet</h2>
                    <div class="balance-display">
                        Total: <span id="total-balance">0.00000000</span> BTC
                    </div>
                </div>

                <div class="utxo-grid" id="utxo-grid">
                    <!-- UTXOs will be dynamically added here -->
                </div>
            </div>

            <!-- Transaction Builder -->
            <div class="transaction-builder">
                <div class="section-header">
                    <h2>📝 Transaction Builder</h2>
                </div>

                <div class="drop-zone" id="drop-zone">
                    <div class="drop-zone-empty" id="empty-message">
                        <div class="icon">👇</div>
                        <h3>Click coins to select them</h3>
                        <p>Build your transaction by selecting UTXOs from your wallet</p>
                    </div>
                    <div class="selected-utxos" id="selected-utxos" style="display: none;"></div>
                </div>

                <!-- Controls -->
                <div class="controls">
                    <div class="control-group">
                        <label>Amount to Send (BTC)</label>
                        <input type="number" id="send-amount" step="0.00000001" min="0" value="0.1" placeholder="0.00000000">
                    </div>
                    <div class="control-group">
                        <label>Fee Rate (sats/vB)</label>
                        <input type="number" id="fee-rate" min="1" value="15" placeholder="15">
                    </div>
                </div>

                <div class="controls">
                    <button class="btn btn-primary" id="validate-tx">Validate Selection</button>
                    <button class="btn btn-secondary" id="hint-btn">💡 Get Hint</button>
                    <button class="btn btn-danger" id="clear-selection">Clear</button>
                </div>

                <!-- Transaction Summary -->
                <div class="tx-summary" id="tx-summary" style="display: none;">
                    <h3>📊 Transaction Summary</h3>
                    <div class="summary-row">
                        <span class="summary-label">Selected UTXOs:</span>
                        <span class="summary-value" id="sum-utxos">0</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Total Input:</span>
                        <span class="summary-value highlight" id="sum-input">0.00000000 BTC</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Amount to Send:</span>
                        <span class="summary-value" id="sum-send">0.00000000 BTC</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Transaction Size:</span>
                        <span class="summary-value" id="sum-size">0 vBytes</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Network Fee:</span>
                        <span class="summary-value" id="sum-fee">0 sats</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Change Output:</span>
                        <span class="summary-value success" id="sum-change">0.00000000 BTC</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Total Cost:</span>
                        <span class="summary-value highlight" id="sum-total">0.00000000 BTC</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights Panel -->
        <div class="insights-panel" id="insights-panel" style="display: none;">
            <h3>💡 Smart Insights</h3>
            <div id="insights-content"></div>
        </div>

        <!-- Privacy Analysis -->
        <div class="privacy-panel" id="privacy-panel" style="display: none;">
            <h3>🔒 Privacy Analysis</h3>
            <div class="privacy-score">
                <span style="font-weight: 600;">Privacy Score:</span>
                <div class="privacy-bar">
                    <div class="privacy-bar-fill" id="privacy-bar-fill" style="width: 0%;">
                        <span id="privacy-score-text">0%</span>
                    </div>
                </div>
            </div>
            <div id="privacy-content"></div>
        </div>

        <!-- Challenge Panel -->
        <div class="challenge-panel" id="challenge-panel" style="display: none;">
            <h3>🏆 Challenge Mode</h3>
            <div class="challenge-objective" id="challenge-objective"></div>
            <div class="challenge-score">
                <div class="score-item">
                    <div class="label">Score</div>
                    <div class="value" id="challenge-score">0</div>
                </div>
                <div class="score-item">
                    <div class="label">Fee Efficiency</div>
                    <div class="value" id="fee-efficiency">0%</div>
                </div>
                <div class="score-item">
                    <div class="label">Privacy Rating</div>
                    <div class="value" id="privacy-rating">0%</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced UTXO Visualizer Logic
        class EnhancedUTXOVisualizer {
            constructor() {
                this.currentScenario = 'intro';
                this.selectedUTXOs = [];
                this.availableUTXOs = [];
                this.scenarioData = this.defineScenarios();
                this.currentStep = 0;
                this.hints = [];
                this.init();
            }

            defineScenarios() {
                return {
                    intro: {
                        name: "Introduction to UTXOs",
                        utxos: [
                            { id: 1, amount: 0.5, address: 'addr1', age: 100, source: 'Alice' },
                            { id: 2, amount: 0.3, address: 'addr2', age: 50, source: 'Bob' },
                            { id: 3, amount: 0.25, address: 'addr3', age: 20, source: 'Mining' }
                        ],
                        target: 0.4,
                        feeRate: 10,
                        instructions: [
                            "Welcome! UTXOs (Unspent Transaction Outputs) are like digital coins in your wallet.",
                            "Each UTXO represents a specific amount of Bitcoin you can spend.",
                            "To send 0.4 BTC, select enough UTXOs to cover the amount + fees.",
                            "Click on the 0.5 BTC UTXO to select it.",
                            "Click 'Validate Selection' to build your transaction."
                        ],
                        hints: [
                            "Look for a UTXO larger than 0.4 BTC",
                            "The 0.5 BTC UTXO is enough to cover your transaction",
                            "Select the 0.5 BTC coin and validate"
                        ],
                        objective: "Learn to select UTXOs by sending 0.4 BTC using the minimum number of inputs."
                    },
                    consolidation: {
                        name: "UTXO Consolidation",
                        utxos: [
                            { id: 1, amount: 0.05, address: 'addr1', age: 200, source: 'Tip' },
                            { id: 2, amount: 0.03, address: 'addr2', age: 180, source: 'Payment' },
                            { id: 3, amount: 0.02, address: 'addr3', age: 150, source: 'Refund' },
                            { id: 4, amount: 0.04, address: 'addr4', age: 120, source: 'Gift' },
                            { id: 5, amount: 0.06, address: 'addr5', age: 100, source: 'Sale' },
                            { id: 6, amount: 0.03, address: 'addr6', age: 80, source: 'Donation' },
                            { id: 7, amount: 0.02, address: 'addr7', age: 60, source: 'Cashback' }
                        ],
                        target: 0.2,
                        feeRate: 3,
                        instructions: [
                            "You have many small UTXOs from various sources.",
                            "Fees are currently LOW (3 sats/vB) - perfect time to consolidate!",
                            "Consolidation means combining multiple small UTXOs into one.",
                            "Send 0.2 BTC to yourself to consolidate these small UTXOs.",
                            "This will save fees on future transactions when fees are high."
                        ],
                        hints: [
                            "Select multiple small UTXOs to reach 0.2 BTC",
                            "More inputs now = fewer inputs needed later",
                            "Try selecting 4-5 of the smaller UTXOs"
                        ],
                        objective: "Consolidate small UTXOs during low fee periods. Send 0.2 BTC using multiple small inputs."
                    },
                    feeOptimization: {
                        name: "Fee Optimization",
                        utxos: [
                            { id: 1, amount: 1.5, address: 'addr1', age: 300, source: 'Savings' },
                            { id: 2, amount: 0.15, address: 'addr2', age: 50, source: 'Trading' },
                            { id: 3, amount: 0.08, address: 'addr3', age: 40, source: 'Friend' },
                            { id: 4, amount: 0.05, address: 'addr4', age: 30, source: 'Gift' },
                            { id: 5, amount: 0.12, address: 'addr5', age: 20, source: 'Payment' }
                        ],
                        target: 0.15,
                        feeRate: 50,
                        instructions: [
                            "Fees are HIGH (50 sats/vB) right now!",
                            "Each input adds ~148 bytes = more fees.",
                            "To send 0.15 BTC efficiently, minimize the number of inputs.",
                            "Choose wisely - fewer inputs = lower fees.",
                            "Compare: 1 input costs ~7,400 sats, but 5 inputs cost ~37,000 sats!"
                        ],
                        hints: [
                            "Look for UTXOs close to 0.15 BTC",
                            "Using just the 0.15 BTC UTXO would be most efficient",
                            "Avoid using many small UTXOs when fees are high"
                        ],
                        objective: "Minimize transaction fees by using the fewest inputs possible. Send 0.15 BTC with optimal efficiency."
                    },
                    privacy: {
                        name: "Privacy Protection",
                        utxos: [
                            { id: 1, amount: 0.8, address: 'addr1', age: 400, source: 'Exchange' },
                            { id: 2, amount: 0.3, address: 'addr1', age: 350, source: 'Refund' },
                            { id: 3, amount: 0.4, address: 'addr2', age: 200, source: 'Mining' },
                            { id: 4, amount: 0.2, address: 'addr3', age: 100, source: 'Friend' },
                            { id: 5, amount: 0.15, address: 'addr3', age: 50, source: 'Sale' }
                        ],
                        target: 0.35,
                        feeRate: 15,
                        instructions: [
                            "Privacy matters! Notice that some UTXOs share the same address.",
                            "When you combine UTXOs from different addresses, you link them publicly.",
                            "This reveals that the same person controls both addresses.",
                            "To send 0.35 BTC with better privacy, use UTXOs from the SAME address.",
                            "The 0.4 BTC UTXO from addr2 is perfect - no address linking!"
                        ],
                        hints: [
                            "Look for UTXOs from unique addresses",
                            "Combining UTXOs from addr1 and addr3 hurts privacy",
                            "Use the single 0.4 BTC UTXO from addr2"
                        ],
                        objective: "Maintain privacy by avoiding address clustering. Send 0.35 BTC without linking addresses."
                    },
                    dust: {
                        name: "Dust Management",
                        utxos: [
                            { id: 1, amount: 0.5, address: 'addr1', age: 200, source: 'Savings' },
                            { id: 2, amount: 0.00001, address: 'addr2', age: 150, source: 'Dust' },
                            { id: 3, amount: 0.0002, address: 'addr3', age: 100, source: 'Faucet' },
                            { id: 4, amount: 0.00015, address: 'addr4', age: 80, source: 'Tip' },
                            { id: 5, amount: 0.3, address: 'addr5', age: 50, source: 'Trading' }
                        ],
                        target: 0.4,
                        feeRate: 20,
                        instructions: [
                            "Some UTXOs are so small they're called 'dust' - they cost more to spend than their value!",
                            "At 20 sats/vB, spending the 0.00001 BTC UTXO costs ~3,000 sats, but it's only worth 1,000 sats!",
                            "To send 0.4 BTC, avoid including dust UTXOs.",
                            "Select the two largest UTXOs (0.5 BTC and 0.3 BTC) to minimize costs.",
                            "Leave the dust UTXOs unspent until fees drop or you can consolidate."
                        ],
                        hints: [
                            "Ignore all UTXOs smaller than 0.001 BTC",
                            "Focus on the 0.5 BTC and 0.3 BTC UTXOs",
                            "Dust UTXOs are uneconomical to spend at current fees"
                        ],
                        objective: "Avoid spending dust that costs more in fees than its value. Send 0.4 BTC efficiently."
                    },
                    challenge: {
                        name: "Expert Challenge",
                        utxos: [
                            { id: 1, amount: 0.6, address: 'addr1', age: 500, source: 'Long-term' },
                            { id: 2, amount: 0.3, address: 'addr1', age: 450, source: 'Savings' },
                            { id: 3, amount: 0.45, address: 'addr2', age: 300, source: 'Trading' },
                            { id: 4, amount: 0.08, address: 'addr3', age: 200, source: 'Payment' },
                            { id: 5, amount: 0.12, address: 'addr4', age: 150, source: 'Gift' },
                            { id: 6, amount: 0.05, address: 'addr5', age: 100, source: 'Tip' },
                            { id: 7, amount: 0.25, address: 'addr2', age: 80, source: 'Mining' }
                        ],
                        target: 0.5,
                        feeRate: 30,
                        instructions: [
                            "Expert challenge: Optimize for BOTH fees and privacy!",
                            "Fees are medium-high (30 sats/vB), so minimize inputs.",
                            "But also avoid linking addresses to preserve privacy.",
                            "Goal: Send 0.5 BTC with optimal fee efficiency AND privacy.",
                            "Think carefully about your selection!"
                        ],
                        hints: [
                            "Look for a single UTXO close to 0.5 BTC",
                            "The 0.6 BTC or 0.45 BTC UTXOs are good candidates",
                            "Best choice: 0.6 BTC (1 input, no address linking)"
                        ],
                        objective: "Achieve the perfect balance: minimum fees, maximum privacy. Score 100 points!"
                    }
                };
            }

            init() {
                this.loadScenario('intro');
                this.attachEventListeners();
            }

            loadScenario(scenarioName) {
                this.currentScenario = scenarioName;
                this.currentStep = 0;
                this.selectedUTXOs = [];

                const scenario = this.scenarioData[scenarioName];
                this.availableUTXOs = scenario.utxos;

                // Update UI
                document.getElementById('send-amount').value = scenario.target;
                document.getElementById('fee-rate').value = scenario.feeRate;

                this.renderUTXOs();
                this.updateBalance();
                this.showInstructions();
                this.updateUI();

                // Show/hide challenge panel
                if (scenarioName === 'challenge') {
                    document.getElementById('challenge-panel').style.display = 'block';
                    document.getElementById('challenge-objective').textContent = scenario.objective;
                } else {
                    document.getElementById('challenge-panel').style.display = 'none';
                }
            }

            showInstructions() {
                const scenario = this.scenarioData[this.currentScenario];
                const panel = document.getElementById('instructions-panel');
                const content = document.getElementById('instructions-content');

                panel.classList.add('visible');

                content.innerHTML = scenario.instructions.map((instruction, index) => `
                    <div class="instruction-step ${index < this.currentStep ? 'completed' : ''} ${index === this.currentStep ? 'active' : ''}">
                        <span class="step-number">${index + 1}</span>
                        ${instruction}
                    </div>
                `).join('');
            }

            attachEventListeners() {
                // Scenario selection
                document.querySelectorAll('.scenario-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('active'));
                        e.currentTarget.classList.add('active');
                        this.loadScenario(e.currentTarget.dataset.scenario);
                    });
                });

                // Buttons
                document.getElementById('validate-tx').addEventListener('click', () => this.validateTransaction());
                document.getElementById('hint-btn').addEventListener('click', () => this.showHint());
                document.getElementById('clear-selection').addEventListener('click', () => this.clearSelection());

                // Inputs
                document.getElementById('send-amount').addEventListener('input', () => this.updateSummary());
                document.getElementById('fee-rate').addEventListener('input', () => this.updateSummary());
            }

            renderUTXOs() {
                const grid = document.getElementById('utxo-grid');
                grid.innerHTML = '';

                this.availableUTXOs.forEach(utxo => {
                    const coin = document.createElement('div');
                    coin.className = 'utxo-coin';
                    coin.dataset.utxoId = utxo.id;

                    // Privacy indicator
                    const addressCount = this.availableUTXOs.filter(u => u.address === utxo.address).length;
                    const privacyIcon = addressCount > 1 ? '🔗' : '🔒';

                    coin.innerHTML = `
                        <div class="coin-privacy" title="${addressCount > 1 ? 'Shared address - privacy risk' : 'Unique address'}">${privacyIcon}</div>
                        <div class="coin-icon">🪙</div>
                        <div class="coin-amount">${utxo.amount.toFixed(8)}</div>
                        <div class="coin-label">BTC</div>
                        <div class="coin-age">${utxo.age} blocks old</div>
                    `;

                    coin.addEventListener('click', () => this.toggleUTXO(utxo.id));

                    grid.appendChild(coin);
                });
            }

            toggleUTXO(utxoId) {
                if (this.selectedUTXOs.includes(utxoId)) {
                    this.deselectUTXO(utxoId);
                } else {
                    this.selectUTXO(utxoId);
                }
            }

            selectUTXO(utxoId) {
                if (!this.selectedUTXOs.includes(utxoId)) {
                    this.selectedUTXOs.push(utxoId);
                    this.updateUI();
                }
            }

            deselectUTXO(utxoId) {
                this.selectedUTXOs = this.selectedUTXOs.filter(id => id !== utxoId);
                this.updateUI();
            }

            clearSelection() {
                this.selectedUTXOs = [];
                this.updateUI();
            }

            updateUI() {
                // Update coin selection visual
                document.querySelectorAll('.utxo-coin').forEach(coin => {
                    const id = parseInt(coin.dataset.utxoId);
                    coin.classList.toggle('selected', this.selectedUTXOs.includes(id));
                });

                // Update drop zone
                const emptyMessage = document.getElementById('empty-message');
                const selectedContainer = document.getElementById('selected-utxos');

                if (this.selectedUTXOs.length === 0) {
                    emptyMessage.style.display = 'block';
                    selectedContainer.style.display = 'none';
                } else {
                    emptyMessage.style.display = 'none';
                    selectedContainer.style.display = 'grid';

                    selectedContainer.innerHTML = this.selectedUTXOs.map(id => {
                        const utxo = this.availableUTXOs.find(u => u.id === id);
                        return `
                            <div class="utxo-coin selected" onclick="visualizer.deselectUTXO(${id})">
                                <div class="coin-icon">🪙</div>
                                <div class="coin-amount">${utxo.amount.toFixed(8)}</div>
                                <div class="coin-label">BTC</div>
                            </div>
                        `;
                    }).join('');
                }

                this.updateSummary();
                this.analyzePrivacy();
            }

            updateSummary() {
                const summary = document.getElementById('tx-summary');
                if (this.selectedUTXOs.length === 0) {
                    summary.style.display = 'none';
                    document.getElementById('insights-panel').style.display = 'none';
                    return;
                }

                summary.style.display = 'block';

                const sendAmount = parseFloat(document.getElementById('send-amount').value) || 0;
                const feeRate = parseInt(document.getElementById('fee-rate').value) || 15;

                const totalInput = this.selectedUTXOs.reduce((sum, id) => {
                    const utxo = this.availableUTXOs.find(u => u.id === id);
                    return sum + utxo.amount;
                }, 0);

                // Fee calculation (inputs × 148 + outputs × 34 + 10 overhead)
                const numInputs = this.selectedUTXOs.length;
                const numOutputs = 2; // recipient + change
                const txSize = (numInputs * 148) + (numOutputs * 34) + 10;
                const feeInSats = txSize * feeRate;
                const feeInBTC = feeInSats / 100000000;

                const change = totalInput - sendAmount - feeInBTC;
                const totalCost = sendAmount + feeInBTC;

                document.getElementById('sum-utxos').textContent = numInputs;
                document.getElementById('sum-input').textContent = totalInput.toFixed(8) + ' BTC';
                document.getElementById('sum-send').textContent = sendAmount.toFixed(8) + ' BTC';
                document.getElementById('sum-size').textContent = txSize + ' vBytes';
                document.getElementById('sum-fee').textContent = feeInSats.toFixed(0) + ' sats (' + feeInBTC.toFixed(8) + ' BTC)';
                document.getElementById('sum-change').textContent = change.toFixed(8) + ' BTC';
                document.getElementById('sum-total').textContent = totalCost.toFixed(8) + ' BTC';

                // Color coding
                const changeElement = document.getElementById('sum-change');
                if (change < 0) {
                    changeElement.classList.remove('success');
                    changeElement.classList.add('danger');
                } else {
                    changeElement.classList.remove('danger');
                    changeElement.classList.add('success');
                }

                this.updateInsights(totalInput, sendAmount, feeInBTC, numInputs, txSize, feeInSats);
            }

            updateInsights(totalInput, sendAmount, feeInBTC, numInputs, txSize, feeInSats) {
                const insights = document.getElementById('insights-panel');
                const content = document.getElementById('insights-content');

                insights.style.display = 'block';
                let tips = [];

                // Insufficient funds
                if (totalInput < sendAmount + feeInBTC) {
                    tips.push(`<div class="insight-item warning"><strong>⚠️ Insufficient Funds:</strong> You need ${((sendAmount + feeInBTC) - totalInput).toFixed(8)} BTC more.</div>`);
                }

                // Fee analysis
                if (numInputs === 1) {
                    tips.push(`<div class="insight-item success"><strong>✅ Optimal Efficiency:</strong> Using only 1 input minimizes your transaction size and fees!</div>`);
                } else if (numInputs <= 3) {
                    tips.push(`<div class="insight-item"><strong>💰 Good Selection:</strong> ${numInputs} inputs is reasonable. Transaction size: ${txSize} vBytes, Fee: ${feeInSats} sats.</div>`);
                } else {
                    tips.push(`<div class="insight-item warning"><strong>⚠️ High Fee Warning:</strong> Using ${numInputs} inputs creates a ${txSize} vBytes transaction costing ${feeInSats} sats. Consider using fewer, larger UTXOs.</div>`);
                }

                // Change analysis
                const change = totalInput - sendAmount - feeInBTC;
                if (change > 0 && change < 0.00001) {
                    tips.push(`<div class="insight-item warning"><strong>🧹 Dust Warning:</strong> Change output of ${change.toFixed(8)} BTC is very small and uneconomical to spend later.</div>`);
                } else if (change >= 0.00001) {
                    tips.push(`<div class="insight-item success"><strong>✅ Good Change:</strong> Change output of ${change.toFixed(8)} BTC is economical to spend later.</div>`);
                }

                content.innerHTML = tips.join('');
            }

            analyzePrivacy() {
                if (this.selectedUTXOs.length === 0) {
                    document.getElementById('privacy-panel').style.display = 'none';
                    return;
                }

                document.getElementById('privacy-panel').style.display = 'block';
                const content = document.getElementById('privacy-content');

                // Get unique addresses in selection
                const addresses = [...new Set(this.selectedUTXOs.map(id => {
                    const utxo = this.availableUTXOs.find(u => u.id === id);
                    return utxo.address;
                }))];

                const addressCount = addresses.length;
                const utxoCount = this.selectedUTXOs.length;

                // Privacy score calculation
                let privacyScore = 100;
                let analysis = [];

                if (utxoCount === 1) {
                    analysis.push(`<p><strong>✅ Excellent Privacy:</strong> Using a single UTXO reveals minimal information.</p>`);
                } else if (addressCount === 1) {
                    analysis.push(`<p><strong>👍 Good Privacy:</strong> All ${utxoCount} UTXOs are from the same address. No new address links created.</p>`);
                    privacyScore = 80;
                } else {
                    analysis.push(`<p><strong>⚠️ Privacy Warning:</strong> You're combining UTXOs from ${addressCount} different addresses!</p>`);
                    analysis.push(`<p>This reveals that all ${addressCount} addresses belong to the same person (you). This is called "address clustering" and reduces privacy.</p>`);
                    privacyScore = Math.max(20, 100 - (addressCount * 15));
                }

                // Update privacy bar
                document.getElementById('privacy-bar-fill').style.width = privacyScore + '%';
                document.getElementById('privacy-score-text').textContent = privacyScore + '%';

                content.innerHTML = analysis.join('');
            }

            showHint() {
                const scenario = this.scenarioData[this.currentScenario];
                const hints = scenario.hints;

                if (!this.hintIndex) this.hintIndex = 0;

                const hint = hints[this.hintIndex % hints.length];
                this.hintIndex++;

                // Highlight relevant UTXOs if applicable
                const sendAmount = parseFloat(document.getElementById('send-amount').value);
                if (this.currentScenario === 'intro') {
                    document.querySelectorAll('.utxo-coin').forEach(coin => {
                        const id = parseInt(coin.dataset.utxoId);
                        const utxo = this.availableUTXOs.find(u => u.id === id);
                        if (utxo.amount >= sendAmount) {
                            coin.classList.add('highlighted');
                            setTimeout(() => coin.classList.remove('highlighted'), 2000);
                        }
                    });
                }

                alert(`💡 Hint: ${hint}`);
            }

            validateTransaction() {
                const sendAmount = parseFloat(document.getElementById('send-amount').value) || 0;
                const feeRate = parseInt(document.getElementById('fee-rate').value) || 15;

                if (this.selectedUTXOs.length === 0) {
                    alert('❌ No UTXOs selected! Please select at least one UTXO to build your transaction.');
                    return;
                }

                const totalInput = this.selectedUTXOs.reduce((sum, id) => {
                    const utxo = this.availableUTXOs.find(u => u.id === id);
                    return sum + utxo.amount;
                }, 0);

                const txSize = (this.selectedUTXOs.length * 148) + (2 * 34) + 10;
                const feeInBTC = (txSize * feeRate) / 100000000;

                if (totalInput < sendAmount + feeInBTC) {
                    alert(`❌ Insufficient funds!\n\nSelected: ${totalInput.toFixed(8)} BTC\nNeeded: ${(sendAmount + feeInBTC).toFixed(8)} BTC\n\nPlease select more UTXOs.`);
                    return;
                }

                // Calculate score for challenge mode
                if (this.currentScenario === 'challenge') {
                    this.calculateChallengeScore(txSize, feeRate);
                }

                // Success feedback
                const change = totalInput - sendAmount - feeInBTC;
                const feeInSats = txSize * feeRate;

                let feedback = `✅ Transaction Valid!\n\n`;
                feedback += `📊 Summary:\n`;
                feedback += `• Inputs: ${this.selectedUTXOs.length} UTXOs\n`;
                feedback += `• Size: ${txSize} vBytes\n`;
                feedback += `• Fee: ${feeInSats} sats (${feeInBTC.toFixed(8)} BTC)\n`;
                feedback += `• Change: ${change.toFixed(8)} BTC\n\n`;

                // Scenario-specific feedback
                if (this.currentScenario === 'intro' && this.selectedUTXOs.length === 1) {
                    feedback += `🎉 Perfect! You used the optimal strategy: selecting a single UTXO larger than your send amount.\n\n`;
                    feedback += `Next: Try the "UTXO Consolidation" scenario!`;
                } else if (this.currentScenario === 'consolidation' && this.selectedUTXOs.length >= 4) {
                    feedback += `🎉 Great consolidation! You combined multiple small UTXOs during low fees.\n\n`;
                    feedback += `This will save you money on future transactions!`;
                } else if (this.currentScenario === 'fee-optimization' && this.selectedUTXOs.length <= 2) {
                    feedback += `🎉 Excellent fee optimization! You minimized inputs during high fee period.\n\n`;
                    feedback += `You saved ${(148 * 50 * 3)} sats compared to using 5 inputs!`;
                } else if (this.currentScenario === 'privacy') {
                    const addresses = [...new Set(this.selectedUTXOs.map(id => {
                        const utxo = this.availableUTXOs.find(u => u.id === id);
                        return utxo.address;
                    }))];
                    if (addresses.length === 1) {
                        feedback += `🎉 Excellent privacy! You avoided linking different addresses together.`;
                    } else {
                        feedback += `⚠️ Privacy could be better. You linked ${addresses.length} addresses together.`;
                    }
                } else if (this.currentScenario === 'dust') {
                    const hasDust = this.selectedUTXOs.some(id => {
                        const utxo = this.availableUTXOs.find(u => u.id === id);
                        return utxo.amount < 0.001;
                    });
                    if (!hasDust) {
                        feedback += `🎉 Smart! You avoided spending dust UTXOs that would cost more in fees than their value.`;
                    } else {
                        feedback += `⚠️ You included dust UTXOs. This increases fees unnecessarily.`;
                    }
                }

                alert(feedback);

                // Advance to next step
                if (this.currentStep < this.scenarioData[this.currentScenario].instructions.length - 1) {
                    this.currentStep++;
                    this.showInstructions();
                }
            }

            calculateChallengeScore(txSize, feeRate) {
                // Score based on efficiency and privacy
                const numInputs = this.selectedUTXOs.length;
                const addresses = [...new Set(this.selectedUTXOs.map(id => {
                    const utxo = this.availableUTXOs.find(u => u.id === id);
                    return utxo.address;
                }))];

                // Fee efficiency (fewer inputs = higher score)
                const feeEfficiency = Math.max(0, 100 - (numInputs - 1) * 20);

                // Privacy score (fewer addresses = higher score)
                const privacyRating = Math.max(0, 100 - (addresses.length - 1) * 25);

                // Overall score
                const score = Math.round((feeEfficiency + privacyRating) / 2);

                document.getElementById('challenge-score').textContent = score;
                document.getElementById('fee-efficiency').textContent = feeEfficiency + '%';
                document.getElementById('privacy-rating').textContent = privacyRating + '%';
            }

            updateBalance() {
                const total = this.availableUTXOs.reduce((sum, utxo) => sum + utxo.amount, 0);
                document.getElementById('total-balance').textContent = total.toFixed(8);
            }
        }

        // Initialize the enhanced visualizer
        const visualizer = new EnhancedUTXOVisualizer();
    </script>
</body>
</html>
