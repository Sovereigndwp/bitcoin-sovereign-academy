<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Builder - Bitcoin Sovereign Academy</title>
    <link rel="stylesheet" href="/css/brand.css">
    <style>
        :root {
            --primary-orange: #f7931a;
            --primary-dark: #1a1a1a;
            --secondary-dark: #2d2d2d;
            --text-light: #e0e0e0;
            --text-dim: #999;
            --success-green: #4caf50;
            --danger-red: #f44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-dark);
            color: var(--text-light);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .header h1 {
            color: var(--primary-orange);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-light);
        }

        .back-btn {
            position: absolute;
            top: 2rem;
            left: 2rem;
            background: var(--primary-orange);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(247, 147, 26, 0.4);
        }

        .builder-interface {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .panel {
            background: var(--secondary-dark);
            border: 1px solid rgba(247, 147, 26, 0.3);
            border-radius: 15px;
            padding: 1rem;
        }

        .panel h3 {
            color: var(--primary-orange);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .utxo-input, .output {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(247, 147, 26, 0.2);
            border-radius: 10px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            color: var(--text-light);
        }

        .utxo-input strong, .output strong {
            color: var(--text-light);
        }

        .utxo-input small, .output small {
            color: var(--text-dim);
        }

        .utxo-input label, .output label {
            color: var(--text-light);
        }

        .utxo-input:hover, .output:hover {
            border-color: var(--primary-orange);
        }

        .utxo-input.selected {
            border-color: var(--success-green);
            background: rgba(76, 175, 80, 0.1);
        }

        .amount-input, .address-input {
            width: 100%;
            padding: 0.8rem;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(247, 147, 26, 0.3);
            border-radius: 8px;
            color: var(--text-light);
            margin-top: 0.5rem;
        }

        .add-output-btn {
            background: var(--primary-orange);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 1rem;
        }

        .transaction-preview {
            background: var(--primary-dark);
            border: 2px solid var(--primary-orange);
            border-radius: 15px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .tx-field {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: rgba(247, 147, 26, 0.1);
            border-radius: 8px;
        }

        .tx-field label {
            color: var(--primary-orange);
            font-weight: bold;
            display: block;
            margin-bottom: 0.5rem;
        }

        .tx-field span {
            color: var(--text-light);
        }

        .fee-calculator {
            background: rgba(0, 0, 0, 0.5);
            padding: 1rem;
            border-radius: 10px;
            margin-top: 0.75rem;
            color: var(--text-light);
        }

        .fee-calculator span {
            color: var(--text-light);
        }

        .fee-calculator strong {
            color: var(--text-light);
        }

        .fee-slider {
            width: 100%;
            margin: 1rem 0;
        }

        .build-tx-btn {
            background: var(--success-green);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }

        .build-tx-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        }

        .educational-tip {
            background: rgba(33, 150, 243, 0.1);
            border-left: 4px solid #2196f3;
            padding: 0.75rem;
            margin: 0.75rem 0;
            border-radius: 0 8px 8px 0;
            color: var(--text-light);
        }

        .educational-tip strong {
            color: #2196f3;
        }

        /* ===== ACCESSIBILITY ENHANCEMENTS (WCAG 2.1 AA) ===== */

        /* Color Contrast - Change dim text from #999 to #b3b3b3 for 4.6:1 ratio */
        .utxo-input small, .output small {
            color: #b3b3b3;
        }

        /* Touch Targets - Minimum 44x44px */
        button, a, [role="button"], input[type="button"], input[type="submit"],
        .back-btn, .add-output-btn, .build-tx-btn, .utxo-input, .output {
            min-height: 44px;
            min-width: 44px;
        }

        /* Focus Indicators */
        *:focus-visible {
            outline: 3px solid var(--primary-orange, #f7931a);
            outline-offset: 2px;
        }

        button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible {
            outline: 3px solid var(--primary-orange, #f7931a);
            outline-offset: 4px;
            box-shadow: 0 0 0 4px rgba(247, 147, 26, 0.2);
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Mobile Reflow */
        @media (max-width: 360px) {
            body {
                overflow-x: hidden;
            }
        }

        @media (max-width: 768px) {
            .builder-interface {
                grid-template-columns: 1fr;
            }
            
            .back-btn {
                position: relative;
                top: auto;
                left: auto;
                margin-bottom: 2rem;
                display: inline-block;
            }
        }
    </style>
    <link rel="stylesheet" href="/css/icons.css">
    <link rel="stylesheet" href="/css/interactive-demos.css">
</head>
<body>
    <script src="/js/config.js"></script>
    <script src="/js/demo-lock-subdomain.js"></script>
    <script src="/js/subdomain-access-control.js"></script>



    <a href="../../" class="back-btn">‚Üê Back to Academy</a>
    
    <div class="container">
        <div class="header">
            <h1>üî® Bitcoin Transaction Builder</h1>
            <p>Learn how Bitcoin transactions work by building them step-by-step</p>
        </div>

        <div class="builder-interface">
            <div class="panel">
                <h3><span data-icon="money"></span> Available UTXOs (Inputs)</h3>
                <p style="color: var(--text-dim); margin-bottom: 1rem;">Select UTXOs to spend:</p>
                
                <div class="utxo-input" onclick="selectUTXO(this)" data-amount="0.05">
                    <strong>UTXO 1</strong><br>
                    Amount: 0.05 BTC<br>
                    <small>TxID: abc123...def456</small>
                </div>
                
                <div class="utxo-input" onclick="selectUTXO(this)" data-amount="0.03">
                    <strong>UTXO 2</strong><br>
                    Amount: 0.03 BTC<br>
                    <small>TxID: ghi789...jkl012</small>
                </div>
                
                <div class="utxo-input" onclick="selectUTXO(this)" data-amount="0.02">
                    <strong>UTXO 3</strong><br>
                    Amount: 0.02 BTC<br>
                    <small>TxID: mno345...pqr678</small>
                </div>

                <div class="educational-tip"><span data-icon="lightbulb"></span> <strong>Tip:</strong> UTXOs are like bills in your wallet. You need to select enough to cover your transaction amount plus fees.
                </div>
            </div>

            <div class="panel">
                <h3>üì§ Transaction Outputs</h3>
                <p style="color: var(--text-dim); margin-bottom: 1rem;">Where to send Bitcoin:</p>
                
                <div class="output" id="output1">
                    <label>Recipient Address:</label>
                    <select class="address-input address-select" style="width: 100%; padding: 0.8rem; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(247, 147, 26, 0.3); border-radius: 8px; color: var(--text-light); margin-top: 0.5rem;">
                        <option value="">-- Select a recipient address --</option>
                        <option value="bc1qar0srrr7xfkvy5l643lydnw9re59gtzzwf5mdq">bc1qar0srrr7xfkvy5l643lydnw9re59gtzzwf5mdq (Native SegWit)</option>
                        <option value="3J98t1WpEZ73CNmYviecrnyiWrnqRhWNLy">3J98t1WpEZ73CNmYviecrnyiWrnqRhWNLy (Nested SegWit)</option>
                        <option value="bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4">bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4 (Bech32)</option>
                        <option value="1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa">1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa (Legacy P2PKH)</option>
                        <option value="bc1p5d7rjq7g6rdk2yhzks9smlaqtedr4dekq08ge8ztwac72sfr9rusxg3297">bc1p5d7rjq7g6rdk2yhzks9smlaqtedr4dekq08ge8ztwac72sfr9rusxg3297 (Taproot)</option>
                    </select>
                    <input type="text" class="address-input address-text" placeholder="bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh" style="display: none; width: 100%; padding: 0.8rem; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(247, 147, 26, 0.3); border-radius: 8px; color: var(--text-light); margin-top: 0.5rem;" />
                    <label>Amount (BTC):</label>
                    <input type="number" class="amount-input" placeholder="0.025" step="0.001" />
                </div>

                <button class="add-output-btn" onclick="addOutput()">+ Add Another Output</button>

                <div class="educational-tip"><span data-icon="lightbulb"></span> <strong>Tip:</strong> If you don't spend all your input UTXOs, the remainder goes to fees unless you create a "change" output back to yourself.
                </div>
            </div>
        </div>

        <div class="transaction-preview">
            <h3 style="color: var(--primary-orange); margin-bottom: 1.5rem;">üìã Transaction Preview</h3>
            
            <div class="tx-field">
                <label>Selected Inputs:</label>
                <span id="selectedInputs">None selected</span>
            </div>
            
            <div class="tx-field">
                <label>Total Input Amount:</label>
                <span id="totalInput">0.00000000 BTC</span>
            </div>
            
            <div class="tx-field">
                <label>Output Amount:</label>
                <span id="totalOutput">0.00000000 BTC</span>
            </div>
            
            <div class="fee-calculator">
                <label style="color: var(--primary-orange);">Transaction Fee:</label>
                <input type="range" class="fee-slider" min="1" max="100" value="10" onchange="updateFee(this.value)">
                <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                    <span>Slow (1 sat/vB)</span>
                    <span id="currentFeeRate">Medium (10 sat/vB)</span>
                    <span>Fast (100 sat/vB)</span>
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Estimated Fee: <span id="estimatedFee">0.00001000 BTC</span></strong>
                </div>
            </div>
            
            <div class="tx-field">
                <label>Change Output:</label>
                <span id="changeAmount">0.00000000 BTC</span>
            </div>

            <button class="build-tx-btn" onclick="buildTransaction()">üî® Build Transaction</button>
        </div>
    </div>

    <script>
        let selectedUTXOs = [];
        let outputCount = 1;
        let currentFeeRate = 10;

        function selectUTXO(element) {
            console.log('Selecting UTXO:', element);
            
            if (!element || !element.dataset) {
                console.error('Invalid UTXO element');
                alert('‚ùå Invalid UTXO element. Please refresh the page.');
                return;
            }
            
            const amount = parseFloat(element.dataset.amount);
            const isSelected = element.classList.contains('selected');
            
            if (isNaN(amount)) {
                console.error('Invalid amount in UTXO:', element.dataset.amount);
                alert('‚ùå Invalid UTXO amount. Please refresh the page.');
                return;
            }
            
            if (isSelected) {
                element.classList.remove('selected');
                selectedUTXOs = selectedUTXOs.filter(utxo => utxo.amount !== amount);
                console.log('UTXO deselected, remaining:', selectedUTXOs.length);
            } else {
                element.classList.add('selected');
                const utxoData = {
                    element: element,
                    amount: amount,
                    id: element.querySelector('small')?.textContent || 'unknown'
                };
                selectedUTXOs.push(utxoData);
                console.log('UTXO selected, total:', selectedUTXOs.length);
            }
            
            updateTransactionPreview();
        }

        function addOutput() {
            console.log('Adding new output...');

            const outputsContainer = document.querySelector('.panel:nth-child(2)');
            if (!outputsContainer) {
                console.error('Outputs container not found');
                alert('‚ùå Interface error. Please refresh the page.');
                return;
            }

            outputCount++;
            const newOutput = document.createElement('div');
            newOutput.className = 'output';
            newOutput.innerHTML = `
                <label>Recipient Address:</label>
                <select class="address-input address-select" style="width: 100%; padding: 0.8rem; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(247, 147, 26, 0.3); border-radius: 8px; color: var(--text-light); margin-top: 0.5rem;">
                    <option value="">-- Select a recipient address --</option>
                    <option value="bc1qar0srrr7xfkvy5l643lydnw9re59gtzzwf5mdq">bc1qar0srrr7xfkvy5l643lydnw9re59gtzzwf5mdq (Native SegWit)</option>
                    <option value="3J98t1WpEZ73CNmYviecrnyiWrnqRhWNLy">3J98t1WpEZ73CNmYviecrnyiWrnqRhWNLy (Nested SegWit)</option>
                    <option value="bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4">bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4 (Bech32)</option>
                    <option value="1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa">1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa (Legacy P2PKH)</option>
                    <option value="bc1p5d7rjq7g6rdk2yhzks9smlaqtedr4dekq08ge8ztwac72sfr9rusxg3297">bc1p5d7rjq7g6rdk2yhzks9smlaqtedr4dekq08ge8ztwac72sfr9rusxg3297 (Taproot)</option>
                </select>
                <input type="text" class="address-input address-text" placeholder="bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh" style="display: none; width: 100%; padding: 0.8rem; background: rgba(0, 0, 0, 0.5); border: 1px solid rgba(247, 147, 26, 0.3); border-radius: 8px; color: var(--text-light); margin-top: 0.5rem;" />
                <label>Amount (BTC):</label>
                <input type="number" class="amount-input" placeholder="0.025" step="0.001" onchange="updateTransactionPreview()" />
                <button onclick="this.parentElement.remove(); outputCount--; updateTransactionPreview(); console.log('Output removed');" style="background: var(--danger-red); color: white; border: none; padding: 0.5rem; border-radius: 5px; margin-top: 0.5rem; cursor: pointer;">Remove</button>
            `;

            const addButton = outputsContainer.querySelector('.add-output-btn');
            if (addButton) {
                outputsContainer.insertBefore(newOutput, addButton);
            } else {
                outputsContainer.appendChild(newOutput);
            }

            console.log('Output added, total outputs:', outputCount);

            // Apply current difficulty mode to new output if enhanced builder exists
            if (window.transactionBuilder) {
                window.transactionBuilder.updateAddressInputMode();
            }

            updateTransactionPreview();
        }

        function updateFee(value) {
            currentFeeRate = parseInt(value);
            document.getElementById('currentFeeRate').textContent = `Custom (${value} sat/vB)`;
            updateTransactionPreview();
        }

        function updateTransactionPreview() {
            const totalInput = selectedUTXOs.reduce((sum, utxo) => sum + utxo.amount, 0);
            
            let totalOutput = 0;
            document.querySelectorAll('.amount-input').forEach(input => {
                if (input.value) {
                    totalOutput += parseFloat(input.value);
                }
            });
            
            const estimatedFee = 0.00001 * currentFeeRate; // Simplified fee calculation
            const changeAmount = totalInput - totalOutput - estimatedFee;
            
            document.getElementById('selectedInputs').textContent = 
                selectedUTXOs.length > 0 ? `${selectedUTXOs.length} UTXOs selected` : 'None selected';
            document.getElementById('totalInput').textContent = totalInput.toFixed(8) + ' BTC';
            document.getElementById('totalOutput').textContent = totalOutput.toFixed(8) + ' BTC';
            document.getElementById('estimatedFee').textContent = estimatedFee.toFixed(8) + ' BTC';
            document.getElementById('changeAmount').textContent = Math.max(0, changeAmount).toFixed(8) + ' BTC';
        }

        function buildTransaction() {
            console.log('Building transaction...');
            
            if (selectedUTXOs.length === 0) {
                alert('‚ùå Please select at least one UTXO to spend!');
                return false;
            }
            
            const outputs = document.querySelectorAll('.output');
            let hasValidOutput = false;
            let totalOutput = 0;
            
            outputs.forEach(output => {
                // Get address from either select dropdown or text input
                const addressSelect = output.querySelector('.address-select');
                const addressText = output.querySelector('.address-text');
                const addressValue = (addressSelect && addressSelect.style.display !== 'none')
                    ? addressSelect.value
                    : (addressText ? addressText.value : '');

                const amountInput = output.querySelector('.amount-input');
                if (addressValue && amountInput?.value && !isNaN(parseFloat(amountInput.value))) {
                    hasValidOutput = true;
                    totalOutput += parseFloat(amountInput.value);
                }
            });
            
            if (!hasValidOutput) {
                alert('‚ùå Please add at least one valid output (address + amount)!');
                return false;
            }
            
            const totalInput = selectedUTXOs.reduce((sum, utxo) => sum + utxo.amount, 0);
            const estimatedFee = 0.00001 * currentFeeRate;
            
            if (totalInput < totalOutput + estimatedFee) {
                alert('‚ùå Insufficient funds! You need at least ' + (totalOutput + estimatedFee).toFixed(8) + ' BTC');
                return false;
            }
            
            // Show success with detailed breakdown
            const changeAmount = totalInput - totalOutput - estimatedFee;
            alert(`üéâ Transaction built successfully!
 <span data-icon="chart"></span> Transaction Summary:
‚Ä¢ Inputs: ${selectedUTXOs.length} UTXOs (${totalInput.toFixed(8)} BTC)
‚Ä¢ Outputs: ${totalOutput.toFixed(8)} BTC
‚Ä¢ Fee: ${estimatedFee.toFixed(8)} BTC (${currentFeeRate} sat/vB)
‚Ä¢ Change: ${changeAmount.toFixed(8)} BTC

In a real Bitcoin wallet, this would:
1. Create the raw transaction
2. Sign with your private keys  
3. Broadcast to the network
 <span data-icon="lightbulb"></span> You've learned the basic structure of Bitcoin transactions!`);
            
            console.log('Transaction built successfully');
            return true;
        }

        // Initialize with safety checks
        console.log('Transaction Builder initialized');
        
        // Test required elements
        const requiredElements = ['selectedInputs', 'totalInput', 'totalOutput', 'estimatedFee', 'changeAmount', 'currentFeeRate'];
        const missingElements = requiredElements.filter(id => !document.getElementById(id));
        
        if (missingElements.length > 0) {
            console.error('Missing required elements:', missingElements);
            alert('Interface error: Missing elements detected. Please refresh the page.');
        } else {
            console.log('All required elements found, updating preview...');
            updateTransactionPreview();
        }
    </script>

    <!-- Enhanced features: Socratic questions, visualizations, difficulty levels -->
    <script src="transaction-builder-enhanced.js"></script>

    <!-- Animated Icon Library -->
    <script src="/js/icon-library.js"></script>
    <script>
        // Inject icons after DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            if (window.IconLibrary) {
                document.querySelectorAll('[data-icon]').forEach(function(element) {
                    var iconName = element.getAttribute('data-icon');
                    if (iconName) {
                        var iconHTML = IconLibrary.get(iconName, 20, true);
                        var span = document.createElement('span');
                        span.innerHTML = iconHTML;
                        span.className = 'icon-inline';
                        span.style.marginRight = '0.5rem';
                        span.style.display = 'inline-block';
                        span.style.verticalAlign = 'middle';
                        element.insertBefore(span, element.firstChild);
                    }
                });
            }
        });
    </script>
</body>
</html>