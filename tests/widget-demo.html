<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Test & Demo | Bitcoin Sovereign Academy</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="../css/widgets.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f0f0f;
            color: #ffffff;
            padding: 2rem;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #F7931A 0%, #FFA940 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        h2 {
            font-size: 1.75rem;
            margin: 3rem 0 1rem;
            color: #F7931A;
            border-bottom: 2px solid #F7931A;
            padding-bottom: 0.5rem;
        }
        
        h3 {
            font-size: 1.25rem;
            margin: 2rem 0 1rem;
            color: #FFA940;
        }
        
        .test-section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #242424;
        }
        
        .test-description {
            color: #b0b0b0;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #242424;
            border-radius: 8px;
            border-left: 3px solid #F7931A;
        }
        
        .widget-container {
            margin: 2rem 0;
            padding: 1.5rem;
            background: #0f0f0f;
            border-radius: 8px;
            border: 1px dashed #444;
        }
        
        .controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            background: #F7931A;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #E58210;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #2196f3;
        }
        
        .btn-secondary:hover {
            background: #1976d2;
        }
        
        .btn-danger {
            background: #ff1744;
        }
        
        .btn-danger:hover {
            background: #d50000;
        }
        
        .status {
            margin-top: 1rem;
            padding: 1rem;
            background: #242424;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.875rem;
        }
        
        .status.success {
            border-left: 3px solid #00c853;
        }
        
        .status.error {
            border-left: 3px solid #ff1744;
        }
        
        .status.info {
            border-left: 3px solid #2196f3;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        code {
            background: #242424;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            color: #FFA940;
        }
        
        .api-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .stat-box {
            padding: 1rem;
            background: #242424;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-box .label {
            font-size: 0.75rem;
            color: #b0b0b0;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .stat-box .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #F7931A;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Widget Test & Demo Page</h1>
        <p style="color: #b0b0b0; margin-bottom: 2rem;">
            Comprehensive testing suite for Bitcoin Sovereign Academy widgets. 
            Test API handlers, visualizations, and interactive components.
        </p>
        
        <!-- API Handler Tests -->
        <div class="test-section">
            <h2>1. API Handler Tests</h2>
            <div class="test-description">
                <strong>Purpose:</strong> Validate the centralized API handler with rate limiting, caching, and fallback mechanisms.
            </div>
            
            <h3>API Statistics</h3>
            <div id="api-stats" class="api-stats"></div>
            
            <h3>Individual API Tests</h3>
            <div class="controls">
                <button class="btn" onclick="testBitcoinPrice()">Test Bitcoin Price</button>
                <button class="btn" onclick="testBlockHeight()">Test Block Height</button>
                <button class="btn" onclick="testMempool()">Test Mempool</button>
                <button class="btn" onclick="testFees()">Test Fees</button>
                <button class="btn" onclick="testHashRate()">Test Hash Rate</button>
                <button class="btn" onclick="testDifficulty()">Test Difficulty</button>
                <button class="btn" onclick="testFearGreed()">Test Fear & Greed</button>
                <button class="btn btn-secondary" onclick="testAllAPIs()">Test All APIs</button>
                <button class="btn btn-danger" onclick="clearAPICache()">Clear Cache</button>
            </div>
            <div id="api-status" class="status info"></div>
        </div>
        
        <!-- Live Market Data Widget Tests -->
        <div class="test-section">
            <h2>2. Live Market Data Widget</h2>
            <div class="test-description">
                <strong>Purpose:</strong> Test real-time Bitcoin price display with multiple view modes.
            </div>
            
            <h3>Minimal View</h3>
            <div class="widget-container">
                <div id="market-minimal"></div>
            </div>
            
            <h3>Compact View</h3>
            <div class="widget-container">
                <div id="market-compact"></div>
            </div>
            
            <h3>Full View</h3>
            <div class="widget-container">
                <div id="market-full"></div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="refreshMarketWidgets()">Refresh All</button>
                <button class="btn btn-secondary" onclick="toggleMarketAutoRefresh()">Toggle Auto-Refresh</button>
            </div>
            <div id="market-status" class="status info">Initializing market widgets...</div>
        </div>
        
        <!-- Network Stats Widget Tests -->
        <div class="test-section">
            <h2>3. Network Stats Widget</h2>
            <div class="test-description">
                <strong>Purpose:</strong> Test Bitcoin network health metrics display.
            </div>
            
            <h3>Minimal View</h3>
            <div class="widget-container">
                <div id="network-minimal"></div>
            </div>
            
            <h3>Compact View</h3>
            <div class="widget-container">
                <div id="network-compact"></div>
            </div>
            
            <h3>Dashboard View</h3>
            <div class="widget-container">
                <div id="network-dashboard"></div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="refreshNetworkWidgets()">Refresh All</button>
                <button class="btn btn-secondary" onclick="toggleNetworkAutoRefresh()">Toggle Auto-Refresh</button>
            </div>
            <div id="network-status" class="status info">Initializing network widgets...</div>
        </div>
        
        <!-- News Ticker Widget Tests -->
        <div class="test-section">
            <h2>4. News Ticker Widget</h2>
            <div class="test-description">
                <strong>Purpose:</strong> Test scrolling news ticker with animation controls.
            </div>
            
            <div class="widget-container">
                <div id="news-ticker"></div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="tickerStart()">Start</button>
                <button class="btn" onclick="tickerStop()">Stop</button>
                <button class="btn" onclick="tickerPause()">Pause</button>
                <button class="btn" onclick="tickerResume()">Resume</button>
                <button class="btn btn-secondary" onclick="tickerAddItem()">Add News Item</button>
                <button class="btn btn-secondary" onclick="tickerChangeSpeed()">Change Speed</button>
            </div>
            <div id="ticker-status" class="status info">Ticker initialized</div>
        </div>
        
        <!-- Performance Tests -->
        <div class="test-section">
            <h2>5. Performance & Error Handling</h2>
            <div class="test-description">
                <strong>Purpose:</strong> Test rate limiting, caching, and fallback mechanisms.
            </div>
            
            <div class="controls">
                <button class="btn" onclick="stressTestAPIs()">Stress Test (50 calls)</button>
                <button class="btn btn-secondary" onclick="testRateLimiting()">Test Rate Limiting</button>
                <button class="btn btn-secondary" onclick="testCaching()">Test Caching</button>
                <button class="btn btn-secondary" onclick="testFallbacks()">Test Fallbacks</button>
            </div>
            <div id="performance-status" class="status info">Ready to test</div>
        </div>
        
        <!-- Back to Home -->
        <div style="text-align: center; margin: 3rem 0;">
            <a href="../index.html" style="color: #b0b0b0; text-decoration: none;">← Back to Academy Home</a>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="../js/widgets/api-handler.js"></script>
    <script src="../js/widgets/live-market-data.js"></script>
    <script src="../js/widgets/network-stats.js"></script>
    <script src="../js/widgets/news-ticker.js"></script>
    
    <script>
        // Initialize API handler with logging enabled
        const apiHandler = new BitcoinAPIHandler({ enableLogging: true });
        
        // Widget instances
        let marketWidgets = {};
        let networkWidgets = {};
        let ticker = null;
        
        // Initialize all widgets on page load
        document.addEventListener('DOMContentLoaded', initializeAllWidgets);
        
        function initializeAllWidgets() {
            initializeMarketWidgets();
            initializeNetworkWidgets();
            initializeTicker();
            updateAPIStats();
            
            // Update API stats every 5 seconds
            setInterval(updateAPIStats, 5000);
        }
        
        // API Handler Tests
        async function testBitcoinPrice() {
            updateStatus('api-status', 'Testing Bitcoin price API...', 'info');
            try {
                const data = await apiHandler.getBitcoinPrice();
                updateStatus('api-status', `✓ Price: $${data.price.toLocaleString()} | Change: ${data.change24h.toFixed(2)}% | Fallback: ${data.isFallback || false}`, 'success');
            } catch (error) {
                updateStatus('api-status', `✗ Error: ${error.message}`, 'error');
            }
        }
        
        async function testBlockHeight() {
            updateStatus('api-status', 'Testing block height API...', 'info');
            try {
                const data = await apiHandler.getBlockHeight();
                updateStatus('api-status', `✓ Block Height: ${data.height.toLocaleString()} | Fallback: ${data.isFallback || false}`, 'success');
            } catch (error) {
                updateStatus('api-status', `✗ Error: ${error.message}`, 'error');
            }
        }
        
        async function testMempool() {
            updateStatus('api-status', 'Testing mempool API...', 'info');
            try {
                const data = await apiHandler.getMempoolStats();
                updateStatus('api-status', `✓ Mempool: ${data.count.toLocaleString()} txs | ${(data.vsize / 1e6).toFixed(2)} MB | Fallback: ${data.isFallback || false}`, 'success');
            } catch (error) {
                updateStatus('api-status', `✗ Error: ${error.message}`, 'error');
            }
        }
        
        async function testFees() {
            updateStatus('api-status', 'Testing fees API...', 'info');
            try {
                const data = await apiHandler.getFeeRecommendations();
                updateStatus('api-status', `✓ Fees - Fast: ${data.fastest} | Half Hour: ${data.halfHour} | Hour: ${data.hour} sat/vB | Fallback: ${data.isFallback || false}`, 'success');
            } catch (error) {
                updateStatus('api-status', `✗ Error: ${error.message}`, 'error');
            }
        }
        
        async function testHashRate() {
            updateStatus('api-status', 'Testing hash rate API...', 'info');
            try {
                const data = await apiHandler.getHashRate();
                const eh = (data.current / 1e18).toFixed(2);
                updateStatus('api-status', `✓ Hash Rate: ${eh} EH/s | Fallback: ${data.isFallback || false}`, 'success');
            } catch (error) {
                updateStatus('api-status', `✗ Error: ${error.message}`, 'error');
            }
        }
        
        async function testDifficulty() {
            updateStatus('api-status', 'Testing difficulty API...', 'info');
            try {
                const data = await apiHandler.getDifficulty();
                updateStatus('api-status', `✓ Difficulty: ${(data.difficulty / 1e12).toFixed(2)}T | Progress: ${data.progressPercent?.toFixed(1)}% | Fallback: ${data.isFallback || false}`, 'success');
            } catch (error) {
                updateStatus('api-status', `✗ Error: ${error.message}`, 'error');
            }
        }
        
        async function testFearGreed() {
            updateStatus('api-status', 'Testing Fear & Greed API...', 'info');
            try {
                const data = await apiHandler.getFearGreedIndex();
                updateStatus('api-status', `✓ Fear & Greed: ${data.value} (${data.classification}) | Fallback: ${data.isFallback || false}`, 'success');
            } catch (error) {
                updateStatus('api-status', `✗ Error: ${error.message}`, 'error');
            }
        }
        
        async function testAllAPIs() {
            updateStatus('api-status', 'Testing all APIs...', 'info');
            const results = await apiHandler.getAllData();
            const successCount = Object.values(results).filter(v => v !== null).length;
            updateStatus('api-status', `✓ All APIs tested | ${successCount}/8 successful`, 'success');
            console.log('All API Results:', results);
        }
        
        function clearAPICache() {
            apiHandler.clearCache();
            updateStatus('api-status', '✓ Cache cleared', 'success');
            updateAPIStats();
        }
        
        function updateAPIStats() {
            const stats = apiHandler.getCacheStats();
            document.getElementById('api-stats').innerHTML = `
                <div class="stat-box">
                    <div class="label">Cache Entries</div>
                    <div class="value">${stats.cacheSize}</div>
                </div>
                ${stats.rateLimits.map(rl => `
                    <div class="stat-box">
                        <div class="label">${rl.domain}</div>
                        <div class="value">${rl.requests}</div>
                    </div>
                `).join('')}
            `;
        }
        
        // Market Widgets
        function initializeMarketWidgets() {
            marketWidgets.minimal = new LiveMarketData({
                container: '#market-minimal',
                view: 'minimal',
                apiHandler: apiHandler
            });
            
            marketWidgets.compact = new LiveMarketData({
                container: '#market-compact',
                view: 'compact',
                apiHandler: apiHandler
            });
            
            marketWidgets.full = new LiveMarketData({
                container: '#market-full',
                view: 'full',
                apiHandler: apiHandler,
                onUpdate: (data) => {
                    updateStatus('market-status', `✓ Updated: $${data.price.toLocaleString()} (${data.change24h.toFixed(2)}%)`, 'success');
                }
            });
        }
        
        function refreshMarketWidgets() {
            Object.values(marketWidgets).forEach(w => w.refresh());
            updateStatus('market-status', 'Refreshing all market widgets...', 'info');
        }
        
        function toggleMarketAutoRefresh() {
            // This is a simplified toggle - you'd need to track state properly
            updateStatus('market-status', 'Auto-refresh toggled', 'info');
        }
        
        // Network Widgets
        function initializeNetworkWidgets() {
            networkWidgets.minimal = new NetworkStats({
                container: '#network-minimal',
                view: 'minimal',
                metrics: ['blockHeight', 'fees'],
                apiHandler: apiHandler
            });
            
            networkWidgets.compact = new NetworkStats({
                container: '#network-compact',
                view: 'compact',
                metrics: ['blockHeight', 'hashrate', 'mempool', 'fees'],
                apiHandler: apiHandler
            });
            
            networkWidgets.dashboard = new NetworkStats({
                container: '#network-dashboard',
                view: 'dashboard',
                apiHandler: apiHandler,
                onUpdate: (data) => {
                    updateStatus('network-status', `✓ Updated: Block ${data.blockHeight?.height.toLocaleString() || 'N/A'}`, 'success');
                }
            });
        }
        
        function refreshNetworkWidgets() {
            Object.values(networkWidgets).forEach(w => w.refresh());
            updateStatus('network-status', 'Refreshing all network widgets...', 'info');
        }
        
        function toggleNetworkAutoRefresh() {
            updateStatus('network-status', 'Auto-refresh toggled', 'info');
        }
        
        // News Ticker
        function initializeTicker() {
            ticker = new NewsTicker({
                container: '#news-ticker',
                speed: 50
            });
        }
        
        function tickerStart() {
            ticker.start();
            updateStatus('ticker-status', '✓ Ticker started', 'success');
        }
        
        function tickerStop() {
            ticker.stop();
            updateStatus('ticker-status', '✓ Ticker stopped', 'info');
        }
        
        function tickerPause() {
            ticker.pause();
            updateStatus('ticker-status', '✓ Ticker paused', 'info');
        }
        
        function tickerResume() {
            ticker.resume();
            updateStatus('ticker-status', '✓ Ticker resumed', 'success');
        }
        
        function tickerAddItem() {
            ticker.addItem({
                icon: '🚀',
                text: 'New item added dynamically!',
                category: 'test'
            });
            updateStatus('ticker-status', '✓ Item added', 'success');
        }
        
        function tickerChangeSpeed() {
            const newSpeed = ticker.config.speed === 50 ? 100 : 50;
            ticker.updateConfig({ speed: newSpeed });
            updateStatus('ticker-status', `✓ Speed changed to ${newSpeed}px/s`, 'success');
        }
        
        // Performance Tests
        async function stressTestAPIs() {
            updateStatus('performance-status', 'Running stress test...', 'info');
            const startTime = Date.now();
            const promises = [];
            
            for (let i = 0; i < 50; i++) {
                promises.push(apiHandler.getBitcoinPrice());
            }
            
            try {
                await Promise.all(promises);
                const duration = Date.now() - startTime;
                updateStatus('performance-status', `✓ Completed 50 calls in ${duration}ms (avg: ${(duration/50).toFixed(2)}ms per call)`, 'success');
            } catch (error) {
                updateStatus('performance-status', `✗ Stress test failed: ${error.message}`, 'error');
            }
        }
        
        async function testRateLimiting() {
            updateStatus('performance-status', 'Testing rate limiting...', 'info');
            // Make rapid calls to test rate limiting
            for (let i = 0; i < 35; i++) {
                await apiHandler.getBitcoinPrice();
            }
            updateStatus('performance-status', '✓ Rate limiting test complete - check console for warnings', 'success');
        }
        
        async function testCaching() {
            updateStatus('performance-status', 'Testing cache...', 'info');
            const start1 = Date.now();
            await apiHandler.getBitcoinPrice();
            const time1 = Date.now() - start1;
            
            const start2 = Date.now();
            await apiHandler.getBitcoinPrice();
            const time2 = Date.now() - start2;
            
            updateStatus('performance-status', `✓ First call: ${time1}ms | Cached call: ${time2}ms | Speedup: ${(time1/time2).toFixed(2)}x`, 'success');
        }
        
        async function testFallbacks() {
            updateStatus('performance-status', 'Testing fallback data...', 'info');
            const data = await apiHandler.getBitcoinPrice();
            updateStatus('performance-status', `✓ Fallback test complete | Using fallback: ${data.isFallback || false}`, 'success');
        }
        
        // Utility function
        function updateStatus(id, message, type) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.className = `status ${type}`;
        }
    </script>
</body>
</html>
