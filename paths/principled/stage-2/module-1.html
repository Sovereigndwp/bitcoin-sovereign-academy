<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module 2.1: The Coordination Problem | The Principled Path</title>
    <meta name="description" content="Why groups fail to cooperate when incentives reward betrayal.">

    <style>
        :root {
            --accent-bronze: #8B6F47;
            --accent-bronze-light: #A0826D;
            --primary-dark: #1a1a1a;
            --secondary-dark: #2d2d2d;
            --accent-bronze: #8B6F47;
            --accent-bronze-light: #A0826D;
            --accent-bronze-light: #A0826D;
            --text-light: #e0e0e0;
            --text-dim: #999;
            --border-color: rgba(139, 111, 71, 0.2);
            --accent-green: #4caf50;
            --accent-red: #ef4444;
            --accent-blue: #2196f3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
            color: var(--text-light);
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Navigation */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: rgba(139, 111, 71, 0.1);
            border: 2px solid var(--accent-bronze);
            border-radius: 0.5rem;
            color: var(--accent-bronze);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background: rgba(139, 111, 71, 0.2);
            transform: translateX(-3px);
        }

        /* Module Header */
        .module-header {
            text-align: center;
            padding: 3rem 2rem;
            background: radial-gradient(circle at center, rgba(139, 111, 71, 0.15) 0%, transparent 70%);
            border-radius: 1.5rem;
            margin-bottom: 3rem;
        }

        .module-number {
            font-size: 1.2rem;
            color: var(--accent-bronze);
            opacity: 0.7;
            margin-bottom: 0.5rem;
        }

        .module-header h1 {
            font-size: 2.5rem;
            color: var(--accent-bronze);
            margin-bottom: 1rem;
        }

        .module-subtitle {
            font-size: 1.3rem;
            color: var(--text-dim);
            font-style: italic;
        }

        /* Content Sections */
        .content-section {
            background: var(--secondary-dark);
            border: 2px solid var(--border-color);
            border-radius: 1rem;
            padding: 2.5rem;
            margin: 2rem 0;
        }

        .content-section h2 {
            color: var(--accent-bronze);
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
        }

        .content-section p {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 1.5rem;
        }

        .key-insight {
            background: rgba(139, 111, 71, 0.1);
            border-left: 4px solid var(--accent-bronze);
            padding: 1.5rem;
            margin: 2rem 0;
            border-radius: 0.5rem;
        }

        .key-insight-title {
            color: var(--accent-bronze);
            font-weight: 700;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }

        /* Interactive Demo */
        .demo-section {
            background: var(--secondary-dark);
            border: 3px solid var(--accent-bronze);
            border-radius: 1rem;
            padding: 2.5rem;
            margin: 3rem 0;
        }

        .demo-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .demo-header h3 {
            color: var(--accent-bronze);
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .demo-description {
            color: var(--text-dim);
            font-size: 1.05rem;
        }

        .demo-canvas {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 2rem;
            margin: 2rem 0;
        }

        .players-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }

        .player-card {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
        }

        .player-card.you {
            border-color: var(--accent-blue);
        }

        .player-card.opponent {
            border-color: var(--accent-red);
        }

        .player-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-bronze);
            margin-bottom: 1rem;
        }

        .player-score {
            font-size: 3rem;
            font-weight: 700;
            margin: 1rem 0;
        }

        .player-score.you {
            color: var(--accent-blue);
        }

        .player-score.opponent {
            color: var(--accent-red);
        }

        .score-label {
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .choice-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 2rem 0;
        }

        .choice-button {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--accent-green), #8bc34a);
            color: white;
            border: none;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .choice-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .choice-button.betray {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .choice-button.betray:hover {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .choice-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .payoff-matrix {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .payoff-matrix h4 {
            color: var(--accent-bronze);
            text-align: center;
            margin-bottom: 1rem;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .matrix-table th,
        .matrix-table td {
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .matrix-table th {
            background: rgba(139, 111, 71, 0.2);
            color: var(--accent-bronze);
            font-weight: 700;
        }

        .matrix-table td {
            font-size: 1.1rem;
        }

        .payoff {
            display: block;
            margin: 0.25rem 0;
        }

        .payoff.you {
            color: var(--accent-blue);
        }

        .payoff.opponent {
            color: var(--accent-red);
        }

        .round-history {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 2rem 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .round-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
        }

        .demo-controls {
            display: grid;
            gap: 1rem;
            margin: 2rem 0;
        }

        .demo-button {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--accent-bronze), var(--accent-bronze-light));
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .demo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(139, 111, 71, 0.4);
        }

        .demo-button.secondary {
            background: rgba(139, 111, 71, 0.2);
            border: 2px solid var(--accent-bronze);
            color: var(--accent-bronze);
        }

        .demo-output {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
            min-height: 80px;
        }

        .output-message {
            color: var(--text-light);
            font-size: 1.05rem;
            margin: 0.5rem 0;
        }

        /* Socratic Questions */
        .socratic-section {
            background: linear-gradient(135deg, rgba(139, 111, 71, 0.1), rgba(139, 111, 71, 0.1));
            border: 2px solid var(--accent-bronze);
            border-radius: 1rem;
            padding: 2.5rem;
            margin: 3rem 0;
        }

        .socratic-section h3 {
            color: var(--accent-bronze);
            font-size: 1.6rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .question-card {
            background: var(--secondary-dark);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .question-number {
            color: var(--accent-bronze);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .question-text {
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 1rem;
            line-height: 1.7;
        }

        .reflection-area {
            width: 100%;
            min-height: 100px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            color: var(--text-light);
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }

        .reflection-area:focus {
            outline: none;
            border-color: var(--accent-bronze);
        }

        /* Navigation Footer */
        .module-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 3rem 0;
            padding: 2rem;
            background: var(--secondary-dark);
            border-radius: 1rem;
        }

        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--accent-bronze), var(--accent-bronze-light));
            color: white;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 111, 71, 0.4);
        }

        .progress-indicator {
            text-align: center;
            color: var(--text-dim);
        }

        /* Interactive Reflection System */
        .reflection-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid rgba(139, 111, 71, 0.2); padding-bottom: 0.5rem; }
        .reflection-tab { background: transparent; color: var(--text-dim); border: 2px solid rgba(139, 111, 71, 0.3); padding: 0.5rem 1.25rem; border-radius: 8px 8px 0 0; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease; }
        .reflection-tab.active { background: linear-gradient(135deg, rgba(139, 111, 71, 0.2), rgba(139, 111, 71, 0.1)); color: var(--accent-bronze); border-color: var(--accent-bronze); }
        .reflection-panel { display: none; padding: 1.5rem; background: rgba(26, 26, 26, 0.8); border-radius: 0 8px 8px 8px; border: 2px solid rgba(139, 111, 71, 0.2); }
        .reflection-panel.active { display: block; }
        .choice-select { width: 100%; padding: 1rem; background: rgba(0, 0, 0, 0.3); border: 2px solid var(--border-color); border-radius: 0.5rem; color: var(--text-light); font-size: 1rem; cursor: pointer; }
        .choice-select:focus { outline: none; border-color: var(--accent-bronze); }
        .feedback-box { margin-top: 1.5rem; padding: 1.5rem; border-radius: 0.5rem; border: 2px solid; display: none; }
        .feedback-box.positive { background: rgba(76, 175, 80, 0.1); border-color: #4caf50; color: var(--text-light); }
        .feedback-box.hint { background: rgba(255, 152, 0, 0.1); border-color: #8B6F47; color: var(--text-light); }
        .feedback-box h5 { margin-top: 0; margin-bottom: 0.5rem; color: inherit; }
        .checklist-reflection { display: flex; flex-direction: column; gap: 0.75rem; }
        .checkbox-label { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(0, 0, 0, 0.3); border-radius: 0.5rem; cursor: pointer; transition: background 0.2s ease; }
        .checkbox-label:hover { background: rgba(0, 0, 0, 0.5); }
        .checkbox-label input[type="checkbox"] { width: 1.25rem; height: 1.25rem; cursor: pointer; }

        /* Responsive */
        @media (max-width: 768px) {
            .players-display {
                grid-template-columns: 1fr;
            }

            .choice-buttons {
                grid-template-columns: 1fr;
            }

            .module-header h1 {
                font-size: 2rem;
            }

            .module-nav {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <div class="nav-buttons">
            <a href="/paths/principled/stage-2/" class="back-button">
                ← Back to Stage 2
            </a>
        </div>

        <!-- Module Header -->
        <header class="module-header">
            <div class="module-number">Stage 2 • Module 1</div>
            <h1>The Coordination Problem</h1>
            <p class="module-subtitle">When incentives reward betrayal, cooperation fails</p>
        </header>

        <!-- Introduction -->
        <section class="content-section">
            <h2>The Prisoner's Dilemma</h2>
            <p>
                Two criminals are arrested. The police lack evidence to convict either one on the main charge,
                but they can convict both on a lesser charge. The police offer each prisoner a deal:
            </p>
            <p>
                <strong>If you betray your partner (testify against them) and they stay silent:</strong> You go free, they get 10 years.<br>
                <strong>If you both betray each other:</strong> You each get 5 years.<br>
                <strong>If you both stay silent:</strong> You each get 1 year (on the lesser charge).
            </p>
            <p>
                The rational choice for <em>each individual</em> is to betray — no matter what the other does.
                But if both follow this logic, they both get 5 years. If they could trust each other to cooperate,
                they'd each only get 1 year.
            </p>

            <div class="key-insight">
                <div class="key-insight-title">🤝 Core Principle</div>
                <p>
                    When individual incentives conflict with collective benefit, cooperation breaks down.
                    This isn't a moral failing — it's rational behavior under perverse incentives.
                    Systems that rely on trust collapse when betrayal is rewarded.
                </p>
            </div>
        </section>

        <!-- The Problem -->
        <section class="content-section">
            <h2>Why Groups Fail to Cooperate</h2>
            <p>
                The Prisoner's Dilemma isn't just a thought experiment. It describes countless real-world failures:
            </p>
            <p>
                <strong>Banking crises:</strong> Every bank knows that if all banks lend conservatively, the system is stable.
                But any single bank can profit by taking more risk — until everyone does, causing collapse.<br><br>

                <strong>Environmental degradation:</strong> Factories know pollution hurts everyone. But the factory that pollutes
                less loses competitive advantage. So everyone pollutes.<br><br>

                <strong>Currency debasement:</strong> Governments know inflation hurts citizens. But the government that
                prints money first gets the benefit. So all governments print, and all currencies degrade.
            </p>

            <div class="key-insight">
                <div class="key-insight-title">💔 The Trust Trap</div>
                <p>
                    "Just trust everyone to do the right thing" isn't a solution — it's wishful thinking.
                    When betrayal is profitable and unpunished, betrayal becomes inevitable. You can't build
                    durable systems on voluntary cooperation when incentives reward defection.
                </p>
            </div>
        </section>

        <!-- Interactive Demo -->
        <section class="demo-section">
            <div class="demo-header">
                <h3>🎮 Interactive Lab: Play the Prisoner's Dilemma</h3>
                <p class="demo-description">
                    You're playing against a rational opponent. Each round, you choose: cooperate or betray.
                    See what happens when both players pursue their own self-interest.
                </p>
            </div>

            <div class="demo-canvas">
                <!-- Payoff Matrix -->
                <div class="payoff-matrix">
                    <h4>Payoff Matrix (Points Per Round)</h4>
                    <table class="matrix-table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Opponent Cooperates</th>
                                <th>Opponent Betrays</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th>You Cooperate</th>
                                <td>
                                    <span class="payoff you">You: +3</span>
                                    <span class="payoff opponent">Opponent: +3</span>
                                </td>
                                <td>
                                    <span class="payoff you">You: 0</span>
                                    <span class="payoff opponent">Opponent: +5</span>
                                </td>
                            </tr>
                            <tr>
                                <th>You Betray</th>
                                <td>
                                    <span class="payoff you">You: +5</span>
                                    <span class="payoff opponent">Opponent: 0</span>
                                </td>
                                <td>
                                    <span class="payoff you">You: +1</span>
                                    <span class="payoff opponent">Opponent: +1</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Players Display -->
                <div class="players-display">
                    <div class="player-card you">
                        <div class="player-name">You</div>
                        <div class="player-score you" id="yourScore">0</div>
                        <div class="score-label">Total Points</div>
                    </div>

                    <div class="player-card opponent">
                        <div class="player-name">Opponent</div>
                        <div class="player-score opponent" id="opponentScore">0</div>
                        <div class="score-label">Total Points</div>
                    </div>
                </div>

                <!-- Choice Buttons -->
                <div class="choice-buttons">
                    <button class="choice-button" onclick="makeChoice('cooperate')">
                        🤝 Cooperate
                    </button>
                    <button class="choice-button betray" onclick="makeChoice('betray')">
                        💔 Betray
                    </button>
                </div>

                <!-- Round History -->
                <div class="round-history" id="roundHistory">
                    <div style="text-align: center; color: var(--text-dim);">
                        Make your first choice to begin...
                    </div>
                </div>

                <div class="demo-controls">
                    <button class="demo-button secondary" onclick="resetGame()">
                        🔄 Reset Game
                    </button>
                </div>

                <div class="demo-output" id="demoOutput">
                    <div class="output-message">Choose cooperate or betray to start playing...</div>
                </div>
            </div>

            <div class="key-insight">
                <div class="key-insight-title">💡 What You're Seeing</div>
                <p>
                    The rational strategy is to always betray — it gives you a better outcome regardless of what
                    your opponent does. But when both players follow this logic, both end up worse off than if they'd
                    cooperated. Bitcoin solves this by removing the need for trust: rules are enforced automatically,
                    making cooperation the only viable strategy.
                </p>
            </div>
        </section>

        <!-- Bitcoin's Solution -->
        <section class="content-section">
            <h2>Bitcoin: Making Cooperation Nash Equilibrium</h2>
            <p>
                Bitcoin doesn't ask miners to "be good." It doesn't rely on trust or voluntary cooperation.
                Instead, it changes the incentives so that <strong>following the rules is the most profitable strategy</strong>.
            </p>
            <p>
                If you try to cheat (create invalid blocks, double-spend), the network rejects your work automatically.
                You waste electricity and earn nothing. But if you play by the rules, you earn block rewards.
            </p>
            <p>
                This transforms the coordination problem into a solved game: <strong>cooperation is now the Nash equilibrium</strong>.
                You can't do better by defecting, so everyone cooperates — not out of altruism, but rational self-interest.
            </p>

            <div class="key-insight">
                <div class="key-insight-title">₿ Bitcoin's Elegant Solution</div>
                <p>
                    Bitcoin doesn't eliminate selfish behavior — it harnesses it. By aligning individual profit with
                    network security, Bitcoin turns the Prisoner's Dilemma on its head. The rational choice is now
                    to cooperate, because cheating is automatically punished and honesty is automatically rewarded.
                </p>
            </div>
        </section>

        <!-- Socratic Questions -->
        <section class="socratic-section">
            <h3>💬 Reflect on What You've Learned</h3>
            <p style="text-align: center; color: var(--text-dim); margin-bottom: 2rem;">
                Test your understanding with interactive reflections.
            </p>

            <!-- Q1: Cooperation Conditions (Checklist) -->
            <div class="question-card">
                <div class="question-number">Question 1</div>
                <div class="question-text">
                    What conditions make cooperation possible despite the Prisoner's Dilemma?
                </div>
                <p style="font-size: 0.95rem; color: var(--text-dim); margin: 1rem 0;">Select conditions that enable cooperation:</p>

                <div class="checklist-reflection">
                    <label class="checkbox-label">
                        <input type="checkbox" id="coop-repeat" onchange="updateCoopFeedback()">
                        <span><strong>Repeated interactions</strong> - Future consequences matter</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="coop-enforce" onchange="updateCoopFeedback()">
                        <span><strong>Automatic enforcement</strong> - Cheating is punished immediately</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="coop-reputation" onchange="updateCoopFeedback()">
                        <span><strong>Reputation systems</strong> - Defectors are identified and avoided</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="coop-payoff" onchange="updateCoopFeedback()">
                        <span><strong>Changed payoffs</strong> - Make cooperation more profitable than betrayal</span>
                    </label>
                </div>
                <div id="coop-feedback" class="feedback-box"></div>
            </div>

            <!-- Q2: Real-World Examples (Multiple Choice) -->
            <div class="question-card">
                <div class="question-number">Question 2</div>
                <div class="question-text">
                    Which real-world system suffers from misaligned incentives (individual vs collective benefit)?
                </div>

                <select class="choice-select" id="example-choice" onchange="checkExample()" style="margin-top: 1rem;">
                    <option value="">— Select One —</option>
                    <option value="tragedy">Tragedy of the commons (overfishing, pollution)</option>
                    <option value="fiat">Fiat currency (inflation benefits govt, hurts savers)</option>
                    <option value="corp">Corporate short-termism (quarterly profits vs long-term health)</option>
                    <option value="all">All of the above</option>
                </select>
                <div id="example-feedback" class="feedback-box"></div>
            </div>

            <!-- Q3: Bitcoin's Payoff Matrix (Multiple Choice) -->
            <div class="question-card">
                <div class="question-number">Question 3</div>
                <div class="question-text">
                    How does Bitcoin make cooperation the rational strategy?
                </div>

                <select class="choice-select" id="bitcoin-choice" onchange="checkBitcoin()" style="margin-top: 1rem;">
                    <option value="">— Select One —</option>
                    <option value="reward">Rewards honest miners, ignores cheaters</option>
                    <option value="punish">Automatically rejects invalid blocks (cheating wastes energy)</option>
                    <option value="both">Both - cooperation profitable, cheating costly</option>
                    <option value="trust">Requires miners to be honest and trustworthy</option>
                </select>
                <div id="bitcoin-feedback" class="feedback-box"></div>
            </div>
        </section>

        <!-- Module Navigation -->
        <nav class="module-nav">
            <a href="/paths/principled/stage-2/" class="nav-link">
                ← Back to Stage 2
            </a>
            <div class="progress-indicator">
                Module 1 of 3 • Stage 2 of 5
            </div>
            <a href="/paths/principled/stage-2/module-2.html" class="nav-link">
                Next: The Corruption Curve →
            </a>
        </nav>
    </div>

    <script>
        // Game State
        let gameState = {
            yourScore: 0,
            opponentScore: 0,
            round: 0,
            history: []
        };

        // Opponent strategies (mix of tit-for-tat and occasional betrayal)
        const opponentStrategies = ['cooperate', 'betray', 'tit-for-tat'];
        let currentStrategy = 'tit-for-tat';
        let lastYourChoice = null;

        function getOpponentChoice() {
            if (currentStrategy === 'cooperate') {
                return 'cooperate';
            } else if (currentStrategy === 'betray') {
                return Math.random() > 0.3 ? 'betray' : 'cooperate';
            } else { // tit-for-tat
                if (lastYourChoice === null) {
                    return 'cooperate';
                }
                // Copy your last move
                return lastYourChoice;
            }
        }

        function makeChoice(yourChoice) {
            gameState.round++;
            const opponentChoice = getOpponentChoice();

            // Calculate payoffs
            let yourPoints = 0;
            let opponentPoints = 0;

            if (yourChoice === 'cooperate' && opponentChoice === 'cooperate') {
                yourPoints = 3;
                opponentPoints = 3;
            } else if (yourChoice === 'cooperate' && opponentChoice === 'betray') {
                yourPoints = 0;
                opponentPoints = 5;
            } else if (yourChoice === 'betray' && opponentChoice === 'cooperate') {
                yourPoints = 5;
                opponentPoints = 0;
            } else { // both betray
                yourPoints = 1;
                opponentPoints = 1;
            }

            gameState.yourScore += yourPoints;
            gameState.opponentScore += opponentPoints;

            // Update displays
            document.getElementById('yourScore').textContent = gameState.yourScore;
            document.getElementById('opponentScore').textContent = gameState.opponentScore;

            // Add to history
            gameState.history.push({
                round: gameState.round,
                yourChoice,
                opponentChoice,
                yourPoints,
                opponentPoints
            });

            updateHistory();
            analyzeRound(yourChoice, opponentChoice, yourPoints, opponentPoints);

            // Store last choice for opponent strategy
            lastYourChoice = yourChoice;

            // Occasionally switch opponent strategy
            if (gameState.round % 5 === 0 && Math.random() > 0.6) {
                currentStrategy = opponentStrategies[Math.floor(Math.random() * opponentStrategies.length)];
            }
        }

        function updateHistory() {
            const historyDiv = document.getElementById('roundHistory');

            if (gameState.history.length === 0) {
                historyDiv.innerHTML = '<div style="text-align: center; color: var(--text-dim);">Make your first choice to begin...</div>';
                return;
            }

            let html = '';
            // Show last 5 rounds
            const recentHistory = gameState.history.slice(-5).reverse();

            recentHistory.forEach(round => {
                const yourChoiceIcon = round.yourChoice === 'cooperate' ? '🤝' : '💔';
                const opponentChoiceIcon = round.opponentChoice === 'cooperate' ? '🤝' : '💔';

                html += `
                    <div class="round-item">
                        <span>Round ${round.round}</span>
                        <span>You: ${yourChoiceIcon} (+${round.yourPoints})</span>
                        <span>Opponent: ${opponentChoiceIcon} (+${round.opponentPoints})</span>
                    </div>
                `;
            });

            historyDiv.innerHTML = html;
        }

        function analyzeRound(yourChoice, opponentChoice, yourPoints, opponentPoints) {
            const output = document.getElementById('demoOutput');
            let message = '';

            if (yourChoice === 'cooperate' && opponentChoice === 'cooperate') {
                message = `
                    <div class="output-message" style="color: var(--accent-green);">
                        ✅ Mutual Cooperation
                    </div>
                    <div class="output-message">
                        Round ${gameState.round}: Both cooperated. You each earned +3 points.
                        This is the best collective outcome, but individually risky.
                    </div>
                `;
            } else if (yourChoice === 'cooperate' && opponentChoice === 'betray') {
                message = `
                    <div class="output-message" style="color: var(--accent-red);">
                        🚨 You Were Betrayed!
                    </div>
                    <div class="output-message">
                        Round ${gameState.round}: You cooperated, opponent betrayed. You earned 0, they earned +5.
                        This is why cooperation fails without enforcement — betrayal is rewarded.
                    </div>
                `;
            } else if (yourChoice === 'betray' && opponentChoice === 'cooperate') {
                message = `
                    <div class="output-message" style="color: #ffaa00;">
                        💰 You Exploited Cooperation
                    </div>
                    <div class="output-message">
                        Round ${gameState.round}: You betrayed, opponent cooperated. You earned +5, they earned 0.
                        Short-term gain, but destroys future cooperation.
                    </div>
                `;
            } else { // both betray
                message = `
                    <div class="output-message" style="color: var(--accent-red);">
                        💔 Mutual Betrayal
                    </div>
                    <div class="output-message">
                        Round ${gameState.round}: Both betrayed. You each earned +1.
                        Worse than mutual cooperation, but rational given the incentives.
                    </div>
                `;
            }

            // Add overall analysis
            if (gameState.round >= 5) {
                const avgYour = (gameState.yourScore / gameState.round).toFixed(1);
                const avgOpp = (gameState.opponentScore / gameState.round).toFixed(1);
                message += `
                    <div class="output-message" style="margin-top: 1rem; color: var(--text-dim);">
                        Average per round: You: ${avgYour} pts, Opponent: ${avgOpp} pts.
                        ${avgYour < 2.5 ? 'Too much betrayal is hurting both of you.' : 'Good cooperation balance!'}
                    </div>
                `;
            }

            output.innerHTML = message;
        }

        function resetGame() {
            gameState = {
                yourScore: 0,
                opponentScore: 0,
                round: 0,
                history: []
            };

            lastYourChoice = null;
            currentStrategy = 'tit-for-tat';

            document.getElementById('yourScore').textContent = '0';
            document.getElementById('opponentScore').textContent = '0';
            updateHistory();

            document.getElementById('demoOutput').innerHTML = `
                <div class="output-message">Game reset. Choose cooperate or betray to start playing...</div>
            `;
        }

        // Interactive Reflection System
        const STORAGE_KEY = 'principled_stage2_module1_reflections';

        // Q1 - Cooperation Conditions Checklist
        function updateCoopFeedback() {
            const repeat = document.getElementById('coop-repeat').checked;
            const enforce = document.getElementById('coop-enforce').checked;
            const reputation = document.getElementById('coop-reputation').checked;
            const payoff = document.getElementById('coop-payoff').checked;
            const count = [repeat, enforce, reputation, payoff].filter(Boolean).length;
            const feedbackDiv = document.getElementById('coop-feedback');

            if (count === 0) { feedbackDiv.style.display = 'none'; return; }

            let feedback = '';
            if (count === 4) {
                feedback = `<h5>✓ Perfect!</h5><p>All four enable cooperation:<br><strong>1. Repeated interactions</strong> - Future matters (tit-for-tat)<br><strong>2. Automatic enforcement</strong> - Cheating punished immediately<br><strong>3. Reputation</strong> - Defectors identified/avoided<br><strong>4. Changed payoffs</strong> - Cooperation more profitable<br><br>Bitcoin uses #2 and #4: automatic enforcement + mining rewards make cooperation rational.</p>`;
                feedbackDiv.className = 'feedback-box positive';
            } else {
                feedback = `<h5>💡 Partial (${count}/4)</h5><p>All four conditions help. Bitcoin primarily uses <strong>automatic enforcement</strong> and <strong>changed payoffs</strong> to solve the dilemma.</p>`;
                feedbackDiv.className = 'feedback-box hint';
            }
            feedbackDiv.innerHTML = feedback;
            feedbackDiv.style.display = 'block';
            saveCheckboxes();
        }

        // Q2 - Real-World Examples
        function checkExample() {
            const choice = document.getElementById('example-choice').value;
            const feedbackDiv = document.getElementById('example-feedback');
            if (!choice) { feedbackDiv.style.display = 'none'; return; }

            let feedback = '';
            if (choice === 'all') {
                feedback = `<h5>✓ Correct - All Three!</h5><p><strong>Tragedy of commons:</strong> Individual profit (overfish) vs collective (sustainable oceans)<br><strong>Fiat currency:</strong> Govt/banks benefit from inflation, savers lose<br><strong>Corporate short-termism:</strong> CEOs maximize quarterly profits, harm long-term<br><br>Bitcoin fixes the fiat problem: No one can inflate supply. Fixed 21M limit aligns individual and collective interests.</p>`;
                feedbackDiv.className = 'feedback-box positive';
            } else {
                feedback = `<h5>💡 True, but all three apply</h5><p>Misaligned incentives appear everywhere: commons, fiat, corporations. Bitcoin solves the fiat problem by making inflation impossible.</p>`;
                feedbackDiv.className = 'feedback-box hint';
            }
            feedbackDiv.innerHTML = feedback;
            feedbackDiv.style.display = 'block';
            saveReflection('q2', choice);
        }

        // Q3 - Bitcoin's Strategy
        function checkBitcoin() {
            const choice = document.getElementById('bitcoin-choice').value;
            const feedbackDiv = document.getElementById('bitcoin-feedback');
            if (!choice) { feedbackDiv.style.display = 'none'; return; }

            let feedback = '';
            if (choice === 'both') {
                feedback = `<h5>✓ Exactly Right!</h5><p><strong>Carrot + Stick:</strong><br>• <strong>Cooperation profitable:</strong> Honest miners earn block rewards<br>• <strong>Cheating costly:</strong> Invalid blocks rejected, energy wasted<br><br>This changes the Nash Equilibrium: Cooperation becomes the rational strategy. Bitcoin doesn't require altruism—it makes honesty profitable.</p>`;
                feedbackDiv.className = 'feedback-box positive';
            } else if (choice === 'trust') {
                feedback = `<h5>⚠️ Opposite of Bitcoin's Design</h5><p>Bitcoin <em>doesn't</em> require trust. The protocol <strong>automatically rejects invalid blocks</strong>. Miners can try to cheat, but the network won't accept their work. Trust is replaced by cryptographic verification.</p>`;
                feedbackDiv.className = 'feedback-box hint';
            } else {
                feedback = `<h5>💡 Partially Correct</h5><p>Bitcoin uses <em>both</em>: rewards for honesty + automatic rejection of cheating. This combination makes cooperation the only profitable strategy.</p>`;
                feedbackDiv.className = 'feedback-box hint';
            }
            feedbackDiv.innerHTML = feedback;
            feedbackDiv.style.display = 'block';
            saveReflection('q3', choice);
        }

        // Persistence functions
        function saveCheckboxes() {
            const reflections = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            reflections['coop-repeat'] = document.getElementById('coop-repeat').checked;
            reflections['coop-enforce'] = document.getElementById('coop-enforce').checked;
            reflections['coop-reputation'] = document.getElementById('coop-reputation').checked;
            reflections['coop-payoff'] = document.getElementById('coop-payoff').checked;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(reflections));
        }

        function saveReflection(key, value) {
            const reflections = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            reflections[key] = value;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(reflections));
        }

        function loadReflections() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const reflections = JSON.parse(saved);
                if (reflections['coop-repeat']) document.getElementById('coop-repeat').checked = true;
                if (reflections['coop-enforce']) document.getElementById('coop-enforce').checked = true;
                if (reflections['coop-reputation']) document.getElementById('coop-reputation').checked = true;
                if (reflections['coop-payoff']) document.getElementById('coop-payoff').checked = true;
                if (reflections['q2']) document.getElementById('example-choice').value = reflections['q2'];
                if (reflections['q3']) document.getElementById('bitcoin-choice').value = reflections['q3'];
                updateCoopFeedback();
                if (reflections['q2']) checkExample();
                if (reflections['q3']) checkBitcoin();
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadReflections();
            let progress = JSON.parse(localStorage.getItem('principled_stage2_progress') || '[]');
            if (!progress.includes('module-1')) {
                progress.push('module-1');
                localStorage.setItem('principled_stage2_progress', JSON.stringify(progress));
            }
        });
    </script>
</body>
</html>
