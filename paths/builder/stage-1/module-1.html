<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Protocol Deep Dive | The Builder Path</title>
    <meta name="description" content="Master Bitcoin's UTXO model, transaction structure, and script language with interactive demos and hands-on exercises.">

    <style>
        :root {
            --primary-orange: #f7931a;
            --primary-dark: #1a1a1a;
            --secondary-dark: #2d2d2d;
            --accent-green: #4caf50;
            --accent-blue: #2196f3;
            --text-light: #e0e0e0;
            --text-dim: #999;
            --border-color: rgba(247, 147, 26, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--primary-dark);
            color: var(--text-light);
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        /* Module Header */
        .module-header {
            background: var(--secondary-dark);
            border-bottom: 2px solid var(--primary-orange);
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .breadcrumb {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .breadcrumb a {
            color: var(--primary-orange);
            text-decoration: none;
        }

        .module-title-section h1 {
            font-size: 1.75rem;
            color: var(--accent-blue);
        }

        /* Content Sections */
        .content-section {
            padding: 2.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .content-section h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--primary-orange);
        }

        .content-section h3 {
            font-size: 1.2rem;
            margin: 1.5rem 0 0.75rem;
            color: var(--accent-blue);
        }

        .content-section p {
            margin-bottom: 1rem;
            color: var(--text-light);
        }

        code {
            background: rgba(247, 147, 26, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            color: var(--primary-orange);
        }

        pre {
            background: var(--secondary-dark);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        pre code {
            background: none;
            padding: 0;
            color: var(--text-light);
        }

        /* Interactive Demo */
        .demo-container {
            background: var(--secondary-dark);
            border: 2px solid var(--accent-blue);
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
        }

        .demo-container h3 {
            color: var(--accent-blue);
            text-align: center;
            margin-bottom: 1.5rem;
        }

        /* Navigation */
        .module-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem 0;
            gap: 1rem;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary-orange);
            color: white;
            text-decoration: none;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: #ff8c00;
        }

        .nav-btn-secondary {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-light);
        }
    </style>
</head>
<body>
    <!-- Module Header -->
    <header class="module-header">
        <div class="container">
            <div class="breadcrumb">
                <a href="/">Home</a> ‚Üí
                <a href="/paths/builder/">The Builder Path</a> ‚Üí
                <a href="/paths/builder/stage-1/">Stage 1</a> ‚Üí
                <span>Module 1</span>
            </div>
            <div class="module-title-section">
                <h1>Bitcoin Protocol Deep Dive</h1>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <!-- Socratic Questions -->
            <section class="content-section">
                <h2>ü§î Before We Begin: Think Like a Protocol Designer</h2>
                <p style="color: var(--text-dim); margin-bottom: 1.5rem;">
                    Before diving into Bitcoin's transaction model, consider the fundamental problems you'd need to solve:
                </p>

                <div style="background: var(--secondary-dark); border-left: 4px solid var(--accent-blue); border-radius: 0.75rem; padding: 1.5rem; margin: 1.5rem 0;">
                    <div style="display: grid; gap: 1rem;">
                        <div style="display: flex; gap: 1rem; align-items: flex-start;">
                            <span style="font-size: 1.5rem;">üí∞</span>
                            <div>
                                <strong style="color: var(--accent-blue);">How do you represent digital money without a bank database?</strong>
                                <p style="color: var(--text-dim); font-size: 0.95rem; margin-top: 0.5rem;">If there's no central ledger tracking account balances, how do you know who owns what?</p>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; align-items: flex-start;">
                            <span style="font-size: 1.5rem;">üîÅ</span>
                            <div>
                                <strong style="color: var(--accent-blue);">How do you prevent double-spending without a trusted authority?</strong>
                                <p style="color: var(--text-dim); font-size: 0.95rem; margin-top: 0.5rem;">What stops someone from spending the same digital coin twice in different transactions?</p>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; align-items: flex-start;">
                            <span style="font-size: 1.5rem;">üîí</span>
                            <div>
                                <strong style="color: var(--accent-blue);">How do you prove ownership without revealing your identity?</strong>
                                <p style="color: var(--text-dim); font-size: 0.95rem; margin-top: 0.5rem;">Can you have privacy AND security in digital transactions?</p>
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; align-items: flex-start;">
                            <span style="font-size: 1.5rem;">üìù</span>
                            <div>
                                <strong style="color: var(--accent-blue);">What data structure would allow 18,000 independent nodes to agree on transaction order?</strong>
                                <p style="color: var(--text-dim); font-size: 0.95rem; margin-top: 0.5rem;">How do you design a system where everyone can verify everything independently?</p>
                            </div>
                        </div>
                    </div>
                </div>

                <p style="margin-top: 1.5rem; text-align: center; font-size: 1.1rem;">
                    <strong style="color: var(--accent-green);">Bitcoin's answer to all of these: The UTXO Model</strong>
                </p>
            </section>

            <!-- UTXO Model -->
            <section class="content-section">
                <h2>The UTXO Model: Bitcoin's Transaction System</h2>

                <p>
                    Bitcoin doesn't track account balances like a bank. Instead, it tracks <strong>Unspent Transaction Outputs (UTXOs)</strong>‚Äî
                    individual "coins" of various denominations that can be spent once and only once.
                </p>

                <h3>How UTXOs Work</h3>
                <p>
                    Think of UTXOs like physical cash:
                </p>
                <ul style="margin-left: 2rem; color: var(--text-dim); margin-bottom: 1rem;">
                    <li>You have several bills in your wallet: $5, $10, $20</li>
                    <li>To pay $15, you give the $20 bill and receive $5 change</li>
                    <li>The $20 bill is now "spent" (destroyed)</li>
                    <li>You receive a new $5 bill as change</li>
                </ul>

                <p>
                    Bitcoin transactions work the same way:
                </p>
                <ul style="margin-left: 2rem; color: var(--text-dim); margin-bottom: 1rem;">
                    <li><strong>Inputs:</strong> UTXOs you're spending (destroyed in the transaction)</li>
                    <li><strong>Outputs:</strong> New UTXOs created for recipients and change</li>
                    <li><strong>Rule:</strong> Sum of outputs ‚â§ Sum of inputs (difference = miner fee)</li>
                </ul>

                <h3>Transaction Structure</h3>
                <p>Every Bitcoin transaction has:</p>

                <pre><code>{
  "txid": "abc123...",        // Unique transaction ID
  "version": 2,               // Transaction version
  "inputs": [                 // UTXOs being spent
    {
      "txid": "def456...",    // Previous transaction
      "vout": 0,              // Output index
      "scriptSig": "...",     // Signature proving ownership
      "sequence": 4294967295
    }
  ],
  "outputs": [                // New UTXOs being created
    {
      "value": 50000000,      // Amount in satoshis
      "scriptPubKey": "..."   // Locking script (conditions)
    }
  ],
  "locktime": 0               // Block height/time lock
}</code></pre>
            </section>

            <!-- Interactive UTXO Demo -->
            <section class="content-section">
                <div class="demo-container">
                    <h3>üéÆ Interactive UTXO Transaction Builder</h3>
                    <p style="color: var(--text-dim); text-align: center; margin-bottom: 1.5rem;">
                        Build a transaction by selecting UTXOs and creating outputs. See how change works!
                    </p>

                    <!-- UTXO Builder Interface -->
                    <div id="utxo-builder" style="background: var(--primary-dark); padding: 2rem; border-radius: 0.75rem;">
                        <!-- Available UTXOs -->
                        <div style="margin-bottom: 2rem;">
                            <h4 style="color: var(--accent-blue); margin-bottom: 1rem; font-size: 1.1rem;">üì¶ Your Available UTXOs (Click to Select)</h4>
                            <div id="available-utxos" style="display: grid; gap: 0.75rem;">
                                <!-- UTXOs will be dynamically added here -->
                            </div>
                        </div>

                        <!-- Transaction Inputs -->
                        <div style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(33, 150, 243, 0.1); border-left: 4px solid var(--accent-blue); border-radius: 0.5rem;">
                            <h4 style="color: var(--accent-blue); margin-bottom: 1rem; font-size: 1.1rem;">üì• Transaction Inputs (Selected UTXOs)</h4>
                            <div id="selected-inputs" style="min-height: 60px;">
                                <p style="color: var(--text-dim); font-size: 0.9rem; font-style: italic;">Click UTXOs above to add as inputs...</p>
                            </div>
                            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--secondary-dark); border-radius: 0.5rem;">
                                <strong style="color: var(--accent-blue);">Total Input Value:</strong>
                                <span id="total-input" style="color: var(--accent-green); font-size: 1.2rem; margin-left: 0.5rem;">0 sats</span>
                            </div>
                        </div>

                        <!-- Transaction Outputs -->
                        <div style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(76, 175, 80, 0.1); border-left: 4px solid var(--accent-green); border-radius: 0.5rem;">
                            <h4 style="color: var(--accent-green); margin-bottom: 1rem; font-size: 1.1rem;">üì§ Transaction Outputs</h4>

                            <div style="display: grid; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-light); font-weight: 600;">Recipient Address:</label>
                                    <input type="text" id="recipient-address" placeholder="bc1q..."
                                           style="width: 100%; padding: 0.75rem; background: var(--secondary-dark); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-light); font-family: monospace;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-light); font-weight: 600;">Amount (satoshis):</label>
                                    <input type="number" id="output-amount" placeholder="e.g., 50000" min="0"
                                           style="width: 100%; padding: 0.75rem; background: var(--secondary-dark); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-light);">
                                </div>
                                <button id="add-output" style="padding: 0.75rem 1.5rem; background: var(--accent-green); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                    Add Output
                                </button>
                            </div>

                            <div id="output-list" style="margin-top: 1rem;">
                                <p style="color: var(--text-dim); font-size: 0.9rem; font-style: italic;">No outputs added yet...</p>
                            </div>

                            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--secondary-dark); border-radius: 0.5rem;">
                                <strong style="color: var(--accent-green);">Total Output Value:</strong>
                                <span id="total-output" style="color: var(--accent-green); font-size: 1.2rem; margin-left: 0.5rem;">0 sats</span>
                            </div>
                        </div>

                        <!-- Transaction Summary -->
                        <div style="padding: 1.5rem; background: rgba(247, 147, 26, 0.1); border: 2px solid var(--primary-orange); border-radius: 0.75rem;">
                            <h4 style="color: var(--primary-orange); margin-bottom: 1rem; font-size: 1.2rem; text-align: center;">‚ö° Transaction Summary</h4>
                            <div style="display: grid; gap: 0.75rem; font-size: 1rem;">
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem;">
                                    <span style="color: var(--text-light);">Total Inputs:</span>
                                    <span id="summary-inputs" style="color: var(--accent-blue); font-weight: 600;">0 sats</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem;">
                                    <span style="color: var(--text-light);">Total Outputs:</span>
                                    <span id="summary-outputs" style="color: var(--accent-green); font-weight: 600;">0 sats</span>
                                </div>
                                <div style="height: 1px; background: var(--border-color);"></div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem;">
                                    <span style="color: var(--text-light); font-weight: 600;">Miner Fee:</span>
                                    <span id="summary-fee" style="color: var(--primary-orange); font-weight: 700; font-size: 1.1rem;">0 sats</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(76, 175, 80, 0.2); border-radius: 0.5rem;">
                                    <span style="color: var(--text-light); font-weight: 600;">Change Required:</span>
                                    <span id="summary-change" style="color: var(--accent-green); font-weight: 700; font-size: 1.1rem;">0 sats</span>
                                </div>
                            </div>

                            <div id="validation-message" style="margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem; text-align: center; font-weight: 600;">
                                <!-- Validation messages will appear here -->
                            </div>

                            <button id="build-transaction" style="width: 100%; margin-top: 1rem; padding: 1rem; background: var(--primary-orange); color: white; border: none; border-radius: 0.5rem; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: all 0.3s;">
                                Build Transaction
                            </button>
                        </div>

                        <!-- Transaction Result -->
                        <div id="transaction-result" style="margin-top: 2rem; padding: 1.5rem; background: var(--secondary-dark); border-radius: 0.75rem; display: none;">
                            <h4 style="color: var(--accent-green); margin-bottom: 1rem; text-align: center;">‚úÖ Transaction Built Successfully!</h4>
                            <pre id="transaction-json" style="font-size: 0.85rem; max-height: 400px; overflow-y: auto;"></pre>
                            <button id="reset-builder" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--secondary-dark); color: var(--text-light); border: 2px solid var(--border-color); border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
                                Build Another Transaction
                            </button>
                        </div>
                    </div>

                    <p style="margin-top: 1rem; text-align: center; color: var(--text-dim); font-size: 0.9rem;">
                        üí° Try creating a transaction with exact change vs. requiring change output. Notice how fees work!
                    </p>
                </div>
            </section>

            <!-- Bitcoin Script -->
            <section class="content-section">
                <h2>Bitcoin Script: Programmable Money</h2>

                <p>
                    UTXOs are locked with Bitcoin Script‚Äîa stack-based programming language that defines spending conditions.
                </p>

                <h3>Common Script Types</h3>

                <p><strong>1. Pay-to-Public-Key-Hash (P2PKH)</strong> - The original Bitcoin address format:</p>
                <pre><code>OP_DUP OP_HASH160 &lt;pubKeyHash&gt; OP_EQUALVERIFY OP_CHECKSIG</code></pre>

                <p style="margin-top: 1rem;"><strong>2. Pay-to-Script-Hash (P2SH)</strong> - Allows complex scripts:</p>
                <pre><code>OP_HASH160 &lt;scriptHash&gt; OP_EQUAL</code></pre>

                <p style="margin-top: 1rem;"><strong>3. Pay-to-Witness-Public-Key-Hash (P2WPKH)</strong> - SegWit format:</p>
                <pre><code>OP_0 &lt;pubKeyHash&gt;</code></pre>

                <p>
                    Scripts enable features like multisignature wallets, timelocks, and atomic swaps without requiring protocol changes!
                </p>
            </section>

            <!-- Key Takeaways -->
            <section class="content-section">
                <div style="background: rgba(76, 175, 80, 0.1); border-left: 4px solid var(--accent-green); border-radius: 0.5rem; padding: 1.5rem; margin: 2rem 0;">
                    <h3 style="color: var(--accent-green); margin-bottom: 1rem;">üéØ Key Takeaways</h3>
                    <ul style="list-style: none; padding-left: 0;">
                        <li style="padding-left: 1.5rem; margin-bottom: 0.5rem; position: relative;">
                            <span style="position: absolute; left: 0; color: var(--accent-green); font-weight: 700;">‚úì</span>
                            Bitcoin uses the UTXO model, not account balances
                        </li>
                        <li style="padding-left: 1.5rem; margin-bottom: 0.5rem; position: relative;">
                            <span style="position: absolute; left: 0; color: var(--accent-green); font-weight: 700;">‚úì</span>
                            Transactions consume inputs and create outputs
                        </li>
                        <li style="padding-left: 1.5rem; margin-bottom: 0.5rem; position: relative;">
                            <span style="position: absolute; left: 0; color: var(--accent-green); font-weight: 700;">‚úì</span>
                            Each UTXO can only be spent once (prevents double-spending)
                        </li>
                        <li style="padding-left: 1.5rem; margin-bottom: 0.5rem; position: relative;">
                            <span style="position: absolute; left: 0; color: var(--accent-green); font-weight: 700;">‚úì</span>
                            Bitcoin Script locks UTXOs with spending conditions
                        </li>
                        <li style="padding-left: 1.5rem; margin-bottom: 0.5rem; position: relative;">
                            <span style="position: absolute; left: 0; color: var(--accent-green); font-weight: 700;">‚úì</span>
                            Difference between inputs and outputs = miner fee
                        </li>
                        <li style="padding-left: 1.5rem; margin-bottom: 0.5rem; position: relative;">
                            <span style="position: absolute; left: 0; color: var(--accent-green); font-weight: 700;">‚úì</span>
                            Every node independently verifies all transactions
                        </li>
                    </ul>
                </div>
            </section>

            <!-- Navigation -->
            <nav class="module-navigation">
                <a href="/paths/builder/stage-1/" class="nav-btn nav-btn-secondary">‚Üê Back to Stage 1</a>
                <button id="complete-module" class="nav-btn">Mark Complete & Continue ‚Üí</button>
            </nav>
        </div>
    </main>

    <script>
        // UTXO Transaction Builder Logic
        const utxoBuilder = {
            availableUTXOs: [
                { id: 'utxo-1', txid: 'abc123...def456', vout: 0, value: 100000, address: 'bc1q...xyz', selected: false },
                { id: 'utxo-2', txid: 'def456...ghi789', vout: 1, value: 50000, address: 'bc1q...abc', selected: false },
                { id: 'utxo-3', txid: 'ghi789...jkl012', vout: 0, value: 75000, address: 'bc1q...def', selected: false },
                { id: 'utxo-4', txid: 'jkl012...mno345', vout: 2, value: 150000, address: 'bc1q...ghi', selected: false },
                { id: 'utxo-5', txid: 'mno345...pqr678', vout: 0, value: 25000, address: 'bc1q...jkl', selected: false }
            ],
            outputs: [],
            feeRate: 10 // sats per vbyte (simplified for learning)
        };

        function initializeBuilder() {
            renderAvailableUTXOs();
            updateSummary();
        }

        function renderAvailableUTXOs() {
            const container = document.getElementById('available-utxos');
            container.innerHTML = utxoBuilder.availableUTXOs.map(utxo => `
                <div id="${utxo.id}" onclick="toggleUTXO('${utxo.id}')"
                     style="padding: 1rem; background: ${utxo.selected ? 'rgba(33, 150, 243, 0.3)' : 'var(--secondary-dark)'};
                            border: 2px solid ${utxo.selected ? 'var(--accent-blue)' : 'var(--border-color)'};
                            border-radius: 0.5rem; cursor: pointer; transition: all 0.3s;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                        <div>
                            <div style="font-family: monospace; font-size: 0.85rem; color: var(--text-dim);">${utxo.txid}:${utxo.vout}</div>
                            <div style="margin-top: 0.25rem; font-size: 0.85rem; color: var(--text-dim);">From: ${utxo.address}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent-green);">${utxo.value.toLocaleString()} sats</div>
                            <div style="font-size: 0.85rem; color: var(--text-dim);">${(utxo.value / 100000000).toFixed(8)} BTC</div>
                        </div>
                    </div>
                    ${utxo.selected ? '<div style="margin-top: 0.5rem; color: var(--accent-blue); font-weight: 600; text-align: center;">‚úì Selected as Input</div>' : ''}
                </div>
            `).join('');
        }

        function toggleUTXO(utxoId) {
            const utxo = utxoBuilder.availableUTXOs.find(u => u.id === utxoId);
            utxo.selected = !utxo.selected;
            renderAvailableUTXOs();
            renderSelectedInputs();
            updateSummary();
        }

        function renderSelectedInputs() {
            const container = document.getElementById('selected-inputs');
            const selected = utxoBuilder.availableUTXOs.filter(u => u.selected);

            if (selected.length === 0) {
                container.innerHTML = '<p style="color: var(--text-dim); font-size: 0.9rem; font-style: italic;">Click UTXOs above to add as inputs...</p>';
                return;
            }

            container.innerHTML = selected.map((utxo, index) => `
                <div style="padding: 0.75rem; background: var(--secondary-dark); border-radius: 0.5rem; margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;">Input #${index + 1}</div>
                            <div style="font-family: monospace; font-size: 0.85rem; color: var(--text-dim);">${utxo.txid}:${utxo.vout}</div>
                        </div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-blue);">${utxo.value.toLocaleString()} sats</div>
                    </div>
                </div>
            `).join('');
        }

        function calculateTotalInput() {
            return utxoBuilder.availableUTXOs
                .filter(u => u.selected)
                .reduce((sum, u) => sum + u.value, 0);
        }

        function calculateTotalOutput() {
            return utxoBuilder.outputs.reduce((sum, o) => sum + o.value, 0);
        }

        function calculateFee() {
            const selectedInputs = utxoBuilder.availableUTXOs.filter(u => u.selected).length;
            const numOutputs = utxoBuilder.outputs.length;

            // Simplified fee calculation for learning purposes
            // Actual: 10 + (148 * inputs) + (34 * outputs) vbytes
            const estimatedSize = 10 + (148 * selectedInputs) + (34 * numOutputs);
            return Math.ceil(estimatedSize * utxoBuilder.feeRate);
        }

        function updateSummary() {
            const totalInput = calculateTotalInput();
            const totalOutput = calculateTotalOutput();
            const fee = calculateFee();
            const change = totalInput - totalOutput - fee;

            document.getElementById('total-input').textContent = `${totalInput.toLocaleString()} sats`;
            document.getElementById('total-output').textContent = `${totalOutput.toLocaleString()} sats`;
            document.getElementById('summary-inputs').textContent = `${totalInput.toLocaleString()} sats`;
            document.getElementById('summary-outputs').textContent = `${totalOutput.toLocaleString()} sats`;
            document.getElementById('summary-fee').textContent = `${fee.toLocaleString()} sats`;
            document.getElementById('summary-change').textContent = change >= 0 ? `${change.toLocaleString()} sats` : '‚ö†Ô∏è Insufficient funds';

            // Validation message
            const validationEl = document.getElementById('validation-message');
            if (totalInput === 0) {
                validationEl.innerHTML = '';
                validationEl.style.background = '';
            } else if (totalInput < totalOutput + fee) {
                validationEl.innerHTML = '‚ö†Ô∏è Inputs must be greater than outputs + fee';
                validationEl.style.background = 'rgba(255, 0, 0, 0.2)';
                validationEl.style.color = '#ff6666';
            } else if (utxoBuilder.outputs.length === 0) {
                validationEl.innerHTML = 'üí° Add at least one output to build transaction';
                validationEl.style.background = 'rgba(255, 221, 0, 0.2)';
                validationEl.style.color = 'var(--primary-orange)';
            } else {
                validationEl.innerHTML = '‚úì Transaction is valid! Ready to build.';
                validationEl.style.background = 'rgba(76, 175, 80, 0.2)';
                validationEl.style.color = 'var(--accent-green)';
            }
        }

        document.getElementById('add-output').addEventListener('click', function() {
            const address = document.getElementById('recipient-address').value.trim();
            const amount = parseInt(document.getElementById('output-amount').value);

            if (!address) {
                alert('Please enter a recipient address');
                return;
            }

            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            utxoBuilder.outputs.push({
                address: address,
                value: amount
            });

            renderOutputList();
            updateSummary();

            // Clear inputs
            document.getElementById('recipient-address').value = '';
            document.getElementById('output-amount').value = '';
        });

        function renderOutputList() {
            const container = document.getElementById('output-list');

            if (utxoBuilder.outputs.length === 0) {
                container.innerHTML = '<p style="color: var(--text-dim); font-size: 0.9rem; font-style: italic;">No outputs added yet...</p>';
                return;
            }

            container.innerHTML = utxoBuilder.outputs.map((output, index) => `
                <div style="padding: 0.75rem; background: var(--secondary-dark); border-radius: 0.5rem; margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Output #${index + 1}</div>
                            <div style="font-family: monospace; font-size: 0.85rem; color: var(--text-dim); word-break: break-all;">${output.address}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-green);">${output.value.toLocaleString()} sats</div>
                            <button onclick="removeOutput(${index})" style="margin-top: 0.5rem; padding: 0.25rem 0.75rem; background: rgba(255, 0, 0, 0.2); color: #ff6666; border: 1px solid #ff6666; border-radius: 0.25rem; cursor: pointer; font-size: 0.85rem;">Remove</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        window.removeOutput = function(index) {
            utxoBuilder.outputs.splice(index, 1);
            renderOutputList();
            updateSummary();
        };

        document.getElementById('build-transaction').addEventListener('click', function() {
            const totalInput = calculateTotalInput();
            const totalOutput = calculateTotalOutput();
            const fee = calculateFee();

            if (totalInput === 0) {
                alert('Please select at least one UTXO input');
                return;
            }

            if (utxoBuilder.outputs.length === 0) {
                alert('Please add at least one output');
                return;
            }

            if (totalInput < totalOutput + fee) {
                alert('Insufficient inputs! Total inputs must cover outputs + fees.');
                return;
            }

            // Build transaction object
            const selectedInputs = utxoBuilder.availableUTXOs.filter(u => u.selected);
            const change = totalInput - totalOutput - fee;

            const transaction = {
                version: 2,
                inputs: selectedInputs.map(utxo => ({
                    txid: utxo.txid,
                    vout: utxo.vout,
                    value: utxo.value,
                    scriptSig: "<signature + pubkey>",
                    sequence: 4294967295
                })),
                outputs: [...utxoBuilder.outputs],
                locktime: 0,
                metadata: {
                    totalInput: totalInput,
                    totalOutput: totalOutput,
                    fee: fee,
                    change: change,
                    feeRate: `${utxoBuilder.feeRate} sats/vbyte`
                }
            };

            // Add change output if needed
            if (change > 546) { // Dust limit
                transaction.outputs.push({
                    address: "bc1q<change-address>",
                    value: change,
                    note: "Change output (back to sender)"
                });
            }

            document.getElementById('transaction-json').textContent = JSON.stringify(transaction, null, 2);
            document.getElementById('transaction-result').style.display = 'block';
            document.getElementById('utxo-builder').style.display = 'none';
        });

        document.getElementById('reset-builder').addEventListener('click', function() {
            // Reset state
            utxoBuilder.availableUTXOs.forEach(u => u.selected = false);
            utxoBuilder.outputs = [];

            // Reset UI
            document.getElementById('transaction-result').style.display = 'none';
            document.getElementById('utxo-builder').style.display = 'block';
            document.getElementById('recipient-address').value = '';
            document.getElementById('output-amount').value = '';

            renderAvailableUTXOs();
            renderSelectedInputs();
            renderOutputList();
            updateSummary();
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeBuilder);
    </script>

    <script>
        document.getElementById('complete-module').addEventListener('click', function() {
            const progress = JSON.parse(localStorage.getItem('learningProgress') || '{}');

            if (!progress.completedModules) {
                progress.completedModules = [];
            }

            if (!progress.completedModules.includes('builder-1-1')) {
                progress.completedModules.push('builder-1-1');
            }

            progress.lastActivity = new Date().toISOString();
            progress.path = 'builder';
            progress.currentStage = 1;
            progress.currentModule = 2;

            localStorage.setItem('learningProgress', JSON.stringify(progress));

            alert('‚úì Module 1 completed! Redirecting to Stage 1 overview...');
            window.location.href = '/paths/builder/stage-1/';
        });
    </script>
    <script src="/js/module-gate.js" defer></script>
</body>
</html>
