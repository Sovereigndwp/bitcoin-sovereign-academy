<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics | BSA Admin</title>
    <meta name="robots" content="noindex, nofollow">
    <style>
        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --surface-2: #1e1e1e;
            --border: #2a2a2a;
            --text: #e0e0e0;
            --muted: #888;
            --accent: #f7931a;
            --accent-dim: rgba(247,147,26,0.15);
            --green: #4CAF50;
            --blue: #3b82f6;
            --purple: #9333ea;
            --red: #ef4444;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

        /* Auth Screen */
        .auth-screen { display:flex; align-items:center; justify-content:center; min-height:100vh; }
        .auth-box { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:2.5rem; max-width:400px; width:90%; text-align:center; }
        .auth-box h1 { font-size:1.5rem; margin-bottom:0.5rem; color:var(--accent); }
        .auth-box p { color:var(--muted); font-size:0.9rem; margin-bottom:1.5rem; }
        .auth-box input { width:100%; padding:0.8rem 1rem; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:1rem; margin-bottom:1rem; outline:none; }
        .auth-box input:focus { border-color:var(--accent); }
        .auth-box button { width:100%; padding:0.8rem; background:var(--accent); color:#000; border:none; border-radius:8px; font-size:1rem; font-weight:600; cursor:pointer; }
        .auth-box button:hover { opacity:0.9; }
        .auth-error { color:var(--red); font-size:0.85rem; margin-top:0.5rem; display:none; }

        /* Dashboard */
        .dashboard { display:none; max-width:1200px; margin:0 auto; padding:1.5rem; }
        .dashboard.active { display:block; }

        /* Header */
        .dash-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; flex-wrap:wrap; gap:1rem; }
        .dash-header h1 { font-size:1.75rem; }
        .dash-header h1 span { color:var(--accent); }
        .controls { display:flex; gap:0.5rem; align-items:center; }
        .range-btn { padding:0.4rem 0.9rem; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--muted); cursor:pointer; font-size:0.85rem; transition:all 0.2s; }
        .range-btn.active { background:var(--accent-dim); border-color:var(--accent); color:var(--accent); }
        .refresh-btn { padding:0.4rem 0.9rem; border-radius:6px; border:1px solid var(--border); background:var(--surface); color:var(--text); cursor:pointer; font-size:0.85rem; }

        /* KPI Cards */
        .kpi-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; margin-bottom:2rem; }
        .kpi-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:1.25rem; }
        .kpi-card .label { font-size:0.8rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:0.5rem; }
        .kpi-card .value { font-size:2rem; font-weight:700; }
        .kpi-card .value.orange { color:var(--accent); }
        .kpi-card .value.green { color:var(--green); }
        .kpi-card .value.blue { color:var(--blue); }
        .kpi-card .value.purple { color:var(--purple); }

        /* Panels */
        .panels { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; margin-bottom:2rem; }
        .panel { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:1.25rem; }
        .panel h3 { font-size:1rem; margin-bottom:1rem; color:var(--text); display:flex; align-items:center; gap:0.5rem; }
        .panel.full-width { grid-column: 1 / -1; }

        /* Chart */
        .chart-area { height:200px; display:flex; align-items:flex-end; gap:2px; padding-top:1rem; }
        .chart-bar { flex:1; background:var(--accent); border-radius:3px 3px 0 0; min-width:4px; position:relative; cursor:pointer; transition:opacity 0.2s; }
        .chart-bar:hover { opacity:0.8; }
        .chart-bar .tooltip { display:none; position:absolute; bottom:calc(100% + 4px); left:50%; transform:translateX(-50%); background:var(--surface-2); border:1px solid var(--border); padding:0.3rem 0.5rem; border-radius:4px; font-size:0.7rem; white-space:nowrap; z-index:10; }
        .chart-bar:hover .tooltip { display:block; }
        .chart-labels { display:flex; gap:2px; margin-top:0.25rem; }
        .chart-labels span { flex:1; text-align:center; font-size:0.6rem; color:var(--muted); min-width:4px; overflow:hidden; }

        /* Tables */
        .data-table { width:100%; border-collapse:collapse; }
        .data-table th { text-align:left; font-size:0.75rem; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; padding:0.5rem 0; border-bottom:1px solid var(--border); }
        .data-table td { padding:0.5rem 0; border-bottom:1px solid var(--border); font-size:0.9rem; }
        .data-table tr:last-child td { border-bottom:none; }
        .data-table .views { color:var(--accent); font-weight:600; text-align:right; }
        .data-table .path { max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

        /* Funnel */
        .funnel { display:flex; flex-direction:column; gap:0.75rem; }
        .funnel-step { display:flex; align-items:center; gap:1rem; }
        .funnel-bar-wrap { flex:1; height:32px; background:var(--bg); border-radius:6px; overflow:hidden; position:relative; }
        .funnel-bar { height:100%; border-radius:6px; display:flex; align-items:center; padding:0 0.75rem; font-size:0.8rem; font-weight:600; color:#fff; min-width:40px; transition:width 0.6s ease; }
        .funnel-label { width:120px; font-size:0.85rem; color:var(--muted); flex-shrink:0; }
        .funnel-count { width:60px; text-align:right; font-weight:600; font-size:0.9rem; flex-shrink:0; }

        /* Event pills */
        .event-list { display:flex; flex-wrap:wrap; gap:0.5rem; }
        .event-pill { padding:0.35rem 0.75rem; background:var(--bg); border:1px solid var(--border); border-radius:20px; font-size:0.8rem; display:flex; align-items:center; gap:0.4rem; }
        .event-pill .count { color:var(--accent); font-weight:600; }

        /* Loading */
        .loading { text-align:center; padding:4rem; color:var(--muted); }
        .loading .spinner { display:inline-block; width:24px; height:24px; border:3px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; margin-bottom:1rem; }
        @keyframes spin { to { transform:rotate(360deg); } }

        /* Responsive */
        @media (max-width:768px) {
            .panels { grid-template-columns:1fr; }
            .kpi-grid { grid-template-columns:repeat(2,1fr); }
            .funnel-label { width:80px; font-size:0.75rem; }
        }
    </style>
</head>
<body>

<!-- Auth Screen -->
<div class="auth-screen" id="authScreen">
    <div class="auth-box">
        <h1>âš¡ BSA Analytics</h1>
        <p>Enter your admin password to access the dashboard.</p>
        <form id="authForm" onsubmit="doLogin(event)">
            <input type="password" id="adminPassword" placeholder="Admin password" autofocus>
            <button type="submit">Sign In</button>
        </form>
        <div class="auth-error" id="authError">Invalid password. Try again.</div>
    </div>
</div>

<!-- Dashboard -->
<div class="dashboard" id="dashboard">
    <div class="dash-header">
        <h1>âš¡ <span>Analytics</span> Dashboard</h1>
        <div class="controls">
            <button class="range-btn active" data-range="7d" onclick="switchRange('7d')">7 days</button>
            <button class="range-btn" data-range="30d" onclick="switchRange('30d')">30 days</button>
            <button class="range-btn" data-range="90d" onclick="switchRange('90d')">90 days</button>
            <button class="refresh-btn" onclick="loadData()">â†» Refresh</button>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="label">Page Views</div>
            <div class="value orange" id="kpiPageViews">â€”</div>
        </div>
        <div class="kpi-card">
            <div class="label">Unique Sessions</div>
            <div class="value blue" id="kpiSessions">â€”</div>
        </div>
        <div class="kpi-card">
            <div class="label">Email Subscribers</div>
            <div class="value green" id="kpiSubscribers">â€”</div>
        </div>
        <div class="kpi-card">
            <div class="label">Total Events</div>
            <div class="value purple" id="kpiEvents">â€”</div>
        </div>
    </div>

    <!-- Daily Trend Chart -->
    <div class="panel full-width" style="grid-column:1/-1; margin-bottom:1.5rem;">
        <h3>ðŸ“ˆ Daily Page Views</h3>
        <div class="chart-area" id="chartArea"></div>
        <div class="chart-labels" id="chartLabels"></div>
    </div>

    <!-- Two-column panels -->
    <div class="panels">
        <!-- Top Pages -->
        <div class="panel">
            <h3>ðŸ“„ Top Pages</h3>
            <table class="data-table" id="topPagesTable">
                <thead><tr><th>Page</th><th style="text-align:right">Views</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Referrers -->
        <div class="panel">
            <h3>ðŸ”— Top Referrers</h3>
            <table class="data-table" id="referrersTable">
                <thead><tr><th>Source</th><th style="text-align:right">Hits</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Conversion Funnel -->
        <div class="panel">
            <h3>ðŸŽ¯ Conversion Funnel</h3>
            <div class="funnel" id="funnelArea"></div>
        </div>

        <!-- Event Breakdown -->
        <div class="panel">
            <h3>ðŸ“Š Event Types</h3>
            <div class="event-list" id="eventList"></div>
        </div>
    </div>

    <div style="text-align:center; padding:1rem; color:var(--muted); font-size:0.8rem;">
        Last updated: <span id="lastUpdated">â€”</span>
    </div>
</div>

<script>
const API_BASE = window.location.origin;
let authToken = sessionStorage.getItem('bsa_admin_token') || '';
let currentRange = '7d';

// Auto-login if token exists
if (authToken) {
    showDashboard();
}

async function doLogin(e) {
    e.preventDefault();
    const pw = document.getElementById('adminPassword').value;
    if (!pw) return;

    try {
        const resp = await fetch(`${API_BASE}/api/admin/auth`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: pw }),
        });

        if (!resp.ok) {
            document.getElementById('authError').style.display = 'block';
            return;
        }

        const data = await resp.json();
        authToken = data.token;
        sessionStorage.setItem('bsa_admin_token', authToken);
        showDashboard();
    } catch (err) {
        document.getElementById('authError').style.display = 'block';
    }
}

function showDashboard() {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('dashboard').classList.add('active');
    loadData();
}

function switchRange(range) {
    currentRange = range;
    document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-range="${range}"]`).classList.add('active');
    loadData();
}

async function loadData() {
    try {
        const resp = await fetch(`${API_BASE}/api/admin/analytics?range=${currentRange}`, {
            headers: { 'Authorization': `Bearer ${authToken}` },
        });

        if (resp.status === 401) {
            // Token expired â€” back to login
            sessionStorage.removeItem('bsa_admin_token');
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('dashboard').classList.remove('active');
            return;
        }

        const data = await resp.json();
        if (!data.success) throw new Error(data.error);
        render(data);
    } catch (err) {
        console.error('Failed to load analytics:', err);
    }
}

function fmt(n) {
    return n >= 1000 ? (n / 1000).toFixed(1) + 'k' : String(n);
}

function render(data) {
    const { overview, topPages, eventBreakdown, dailyTrend, topReferrers, funnel } = data;

    // KPIs
    document.getElementById('kpiPageViews').textContent = fmt(overview.pageViews);
    document.getElementById('kpiSessions').textContent = fmt(overview.uniqueSessions);
    document.getElementById('kpiSubscribers').textContent = fmt(overview.totalSubscribers);
    document.getElementById('kpiEvents').textContent = fmt(overview.totalEvents);

    // Daily trend chart
    const chartArea = document.getElementById('chartArea');
    const chartLabels = document.getElementById('chartLabels');
    chartArea.innerHTML = '';
    chartLabels.innerHTML = '';

    if (dailyTrend.length > 0) {
        const maxViews = Math.max(...dailyTrend.map(d => d.views), 1);
        dailyTrend.forEach(d => {
            const pct = (d.views / maxViews) * 100;
            const bar = document.createElement('div');
            bar.className = 'chart-bar';
            bar.style.height = Math.max(pct, 2) + '%';
            bar.innerHTML = `<div class="tooltip">${d.date}: ${d.views} views</div>`;
            chartArea.appendChild(bar);

            const lbl = document.createElement('span');
            lbl.textContent = d.date.slice(5); // MM-DD
            chartLabels.appendChild(lbl);
        });
    } else {
        chartArea.innerHTML = '<div style="color:var(--muted);margin:auto;">No data for this period</div>';
    }

    // Top pages table
    const tbody = document.querySelector('#topPagesTable tbody');
    tbody.innerHTML = topPages.slice(0, 15).map(p =>
        `<tr><td class="path" title="${p.path}">${p.path}</td><td class="views">${p.views}</td></tr>`
    ).join('') || '<tr><td colspan="2" style="color:var(--muted)">No data</td></tr>';

    // Referrers table
    const refBody = document.querySelector('#referrersTable tbody');
    refBody.innerHTML = topReferrers.slice(0, 10).map(r =>
        `<tr><td>${r.source}</td><td class="views">${r.count}</td></tr>`
    ).join('') || '<tr><td colspan="2" style="color:var(--muted)">No referrer data</td></tr>';

    // Conversion funnel
    const funnelArea = document.getElementById('funnelArea');
    const funnelSteps = [
        { label: 'Page Views', count: funnel.pageViews, color: 'var(--blue)' },
        { label: 'Pricing Views', count: funnel.pricingViews, color: 'var(--accent)' },
        { label: 'Email Captures', count: funnel.emailCaptures, color: 'var(--green)' },
        { label: 'Tip Clicks', count: funnel.tipClicks, color: 'var(--purple)' },
    ];
    const maxFunnel = Math.max(...funnelSteps.map(s => s.count), 1);
    funnelArea.innerHTML = funnelSteps.map(s => {
        const pct = Math.max((s.count / maxFunnel) * 100, 3);
        return `<div class="funnel-step">
            <div class="funnel-label">${s.label}</div>
            <div class="funnel-bar-wrap">
                <div class="funnel-bar" style="width:${pct}%;background:${s.color}">${s.count}</div>
            </div>
        </div>`;
    }).join('');

    // Event breakdown
    const eventList = document.getElementById('eventList');
    eventList.innerHTML = eventBreakdown.map(e =>
        `<div class="event-pill"><span class="count">${e.count}</span> ${e.type}</div>`
    ).join('') || '<span style="color:var(--muted)">No events</span>';

    // Timestamp
    document.getElementById('lastUpdated').textContent = new Date(data.timestamp).toLocaleString();
}
</script>
</body>
</html>
